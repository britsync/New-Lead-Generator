<!DOCTYPE html>
<html lang="en">
<!--
========================================
LEAD GENERATION DASHBOARD - SETUP GUIDE
========================================

Before using this dashboard, you MUST configure your n8n webhook URL:

1. Open this file (index.html) in a text editor (VS Code, Notepad++, Sublime Text, etc.)
2. Scroll down to the JavaScript section and find the "CONFIGURATION SECTION"
3. Replace 'YOUR_N8N_WEBHOOK_URL_HERE' with your actual n8n webhook URL
4. Save the file
5. Upload to GitHub Pages or your web hosting

Example webhook URL:
https://your-n8n-instance.com/webhook/lead-campaign

That's it! The dashboard will automatically use your configured webhook URL.
========================================
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Generation Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  
  <!-- Toast Notifications Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Email Preview Modal -->
  <div id="email-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="modal-backdrop fixed inset-0" onclick="closeEmailModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
          <h3 class="text-xl font-semibold text-gray-900">Email Preview</h3>
          <button onclick="closeEmailModal()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="email-preview-content" class="p-6"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Lead Generation Dashboard</h1>
        <p class="text-lg text-gray-600 italic">Upload your campaign data to trigger lead generation and get detailed reports</p>
      </div>
      
      <!-- Demo Mode Toggle -->
      <div class="mt-6 max-w-3xl mx-auto">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="demo-mode" onchange="toggleDemoMode()" class="rounded">
            <label for="demo-mode" class="text-sm text-gray-600">Demo Mode (use mock data for testing)</label>
          </div>
        </div>
      </div>

      <!-- Last Campaign Summary -->
      <div id="last-campaign-summary" class="mt-4 max-w-3xl mx-auto hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-gray-600">
          <span class="font-medium">Last Campaign:</span> <span id="last-campaign-text"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- File Upload Section -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">üì§ Upload Campaign File</h2>
      <p class="text-sm text-gray-600 mb-4">Upload any file format and let AI convert it to campaign configuration</p>
      
      <!-- Supported File Types -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìÑ</div>
          <div class="text-xs font-semibold text-gray-700">JSON</div>
          <div class="text-xs text-gray-500">Config file</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìä</div>
          <div class="text-xs font-semibold text-gray-700">CSV</div>
          <div class="text-xs text-gray-500">Spreadsheet</div>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìà</div>
          <div class="text-xs font-semibold text-gray-700">Excel</div>
          <div class="text-xs text-gray-500">.xlsx, .xls</div>
        </div>
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìù</div>
          <div class="text-xs font-semibold text-gray-700">Word</div>
          <div class="text-xs text-gray-500">.docx, .doc</div>
        </div>
      </div>

      <!-- File Input with Drag & Drop -->
      <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer mb-4">
        <input
          type="file"
          id="campaign-file-upload"
          accept=".json,.csv,.xlsx,.xls,.docx,.doc"
          class="hidden"
          onchange="handleCampaignFileUpload(event)"
        />
        <div id="file-drop-content">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p class="text-sm text-gray-600 mb-1">Drag &amp; drop your file here, or <span class="text-blue-600 font-semibold">browse</span></p>
          <p class="text-xs text-gray-500">Supports JSON, CSV, Excel, Word (max 10MB)</p>
        </div>
      </div>

      <!-- File Analysis Preview -->
      <div id="file-analysis-section" class="hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <div id="file-icon" class="text-3xl">üìÑ</div>
              <div>
                <div class="font-semibold text-gray-900" id="file-name-display"></div>
                <div class="text-xs text-gray-500" id="file-size-display"></div>
              </div>
            </div>
            <button onclick="clearFileUpload()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Conversion Status -->
          <div id="conversion-status" class="hidden mb-3">
            <div class="flex items-center gap-2 text-sm">
              <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
              <span id="conversion-status-text" class="text-gray-700">üì§ Uploading file...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
              <div id="conversion-progress-bar" class="progress-bar h-full bg-blue-600 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <!-- File Preview -->
          <div id="file-preview" class="hidden">
            <div class="text-xs font-semibold text-gray-700 mb-2">File Preview:</div>
            <div id="file-preview-content" class="bg-white border border-gray-200 rounded p-3 text-xs font-mono max-h-40 overflow-auto"></div>
          </div>

          <!-- Detected Data -->
          <div id="detected-data" class="hidden mt-3">
            <div class="text-xs font-semibold text-gray-700 mb-2">Detected Information:</div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <span class="text-gray-500">Campaign Name:</span>
                <span id="detected-campaign-name" class="ml-1 font-medium text-gray-900">-</span>
              </div>
              <div>
                <span class="text-gray-500">Industry:</span>
                <span id="detected-industry" class="ml-1 font-medium text-gray-900">-</span>
              </div>
              <div>
                <span class="text-gray-500">Location:</span>
                <span id="detected-location" class="ml-1 font-medium text-gray-900">-</span>
              </div>
              <div>
                <span class="text-gray-500">Rows/Records:</span>
                <span id="detected-rows" class="ml-1 font-medium text-gray-900">-</span>
              </div>
            </div>
          </div>

          <!-- Conversion Results -->
          <div id="conversion-results" class="hidden mt-3">
            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-green-800">‚úÖ Conversion Completed!</span>
              </div>
              <div class="grid grid-cols-3 gap-2 text-xs">
                <div>
                  <div class="text-gray-600">Data Quality</div>
                  <div id="data-quality" class="font-semibold text-gray-900">High</div>
                </div>
                <div>
                  <div class="text-gray-600">Confidence</div>
                  <div id="confidence-score" class="font-semibold text-gray-900">95%</div>
                </div>
                <div>
                  <div class="text-gray-600">Output Format</div>
                  <div id="output-format" class="font-semibold text-gray-900">JSON</div>
                </div>
              </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
              <button id="use-conversion-btn" onclick="useConvertedJSON()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors disabled:opacity-50" disabled>
                Use Converted JSON
              </button>
              <button onclick="clearFileUpload()" class="text-sm text-gray-500 hover:text-gray-700">
                Clear File
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Conversion Button -->
      <div class="flex justify-center">
        <!-- REMOVED: <button id="convert-file-btn" onclick="convertFile()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:opacity-50">
          Convert with AI
        </button> -->
      </div>
    </div>

    <!-- Campaign Configuration Section -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">‚öôÔ∏è Campaign Configuration</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Left Column: JSON Input -->
        <div class="md:col-span-2">
          <label for="campaign-json" class="block text-sm font-medium text-gray-700 mb-2">Campaign JSON</label>
          <textarea
            id="campaign-json"
            rows="15"
            class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-blue-500 focus:border-blue-500"
            placeholder='{
  "campaign_name": "Tech Startups NY",
  "industry": "Technology",
  "location": "New York, NY",
  "company_size": "1-50",
  "scraping_sources": [
    "linkedin",
    "company_website"
  ]
}'
            oninput="validateJSON()"
          ></textarea>
          <div id="json-error" class="text-red-500 text-sm mt-2 hidden">Invalid JSON format.</div>
          <div class="flex justify-between mt-3">
            <button onclick="loadSampleJSON()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Load Sample</button>
            <button onclick="clearForm()" class="text-sm text-gray-500 hover:text-gray-700 font-medium">Clear</button>
          </div>
        </div>
        
        <!-- Right Column: Pipeline & Options -->
        <div>
          <div class="mb-6">
            <label for="pipeline-select" class="block text-sm font-medium text-gray-700 mb-2">Select Pipeline</label>
            <select id="pipeline-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="linkedin_profile_urls">LinkedIn/Web Scraping</option>
              <option value="google_maps_scraper">Google Maps Scraper</option>
              <option value="facebook_search_scraper">Facebook Search Scraper</option>
              <option value="instagram_scraper">Instagram Scraper</option>
              <option value="tiktok_scraper">TikTok Scraper</option>
              <option value="social_media">Multi-Channel Social</option>
            </select>
          </div>
          
          
          
          
          
          <div class="mb-6">
            <label for="email-language" class="block text-sm font-medium text-gray-700 mb-2">Email Language</label>
            <select id="email-language" onchange="updateEmailLanguage()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
              <option value="english">English</option>
              <option value="spanish">Spanish</option>
              <option value="french">French</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="mt-6 flex justify-between items-center">
        <button id="run-campaign-btn" onclick="runCampaign()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50" disabled>
          Run Campaign
        </button>
        <div class="flex space-x-3">
          <button onclick="clearForm()" class="text-gray-600 hover:text-gray-800 font-medium py-3 px-4 rounded-lg border border-gray-300">
            Clear
          </button>
          <button onclick="duplicateLastCampaign()" class="text-blue-600 hover:text-blue-800 font-medium py-3 px-4 rounded-lg border border-blue-300">
            Duplicate Last
          </button>
        </div>
      </div>
    </div>

    <!-- Campaign Status Section -->
    <div id="status-section" class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6 hidden">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Campaign Status</h2>
      
      <div class="flex justify-between items-center mb-4">
        <div>
          <span class="text-sm font-medium text-gray-500">Campaign ID:</span>
          <span id="campaign-id" class="text-sm font-semibold text-gray-800">camp_vcD4v35uk_1762991597620</span>
        </div>
        <div>
          <span class="text-sm font-medium text-gray-500">Elapsed Time:</span>
          <span id="elapsed-time" class="text-sm font-semibold text-gray-800">0:00</span>
        </div>
      </div>
      
      <div class="flex items-center space-x-3 mb-4">
        <div id="status-indicator" class="w-4 h-4 rounded-full bg-blue-500 pulse-animation"></div>
        <span id="status-text" class="text-lg font-semibold text-gray-800">Running</span>
      </div>
      
      <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
        <div id="progress-bar" class="progress-bar h-2.5 bg-blue-600 rounded-full" style="width: 0%"></div>
      </div>
      <div class="flex justify-end text-sm font-medium text-gray-600">
        <span id="progress-percentage">0</span>% Complete
      </div>
      
      <div class="mt-4">
        <span class="text-sm font-medium text-gray-500">Current Step:</span>
        <div id="current-step" class="text-lg font-semibold text-gray-800">Initializing campaign...</div>
      </div>
      
      <div class="mt-2">
        <span class="text-sm font-medium text-gray-500">Estimated Time Remaining:</span>
        <span id="estimated-time" class="text-sm font-semibold text-gray-800">Calculating...</span>
      </div>
    </div>

    <!-- Campaign Results Section -->
    <div id="results-section" class="bg-white rounded-lg shadow-md border border-gray-200 p-6 hidden">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">‚úÖ Campaign Results</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
          <div class="text-4xl font-bold text-green-800" id="hot-leads-count">0</div>
          <div class="text-sm font-medium text-green-700">Hot Leads</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <div class="text-4xl font-bold text-blue-800" id="other-leads-count">0</div>
          <div class="text-sm font-medium text-blue-700">Other Leads</div>
        </div>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
          <div class="text-4xl font-bold text-gray-800" id="total-leads">0</div>
          <div class="text-sm font-medium text-gray-700">Total Leads Found</div>
        </div>
      </div>
      
      <div class="flex justify-between items-center text-sm text-gray-600 mb-6">
        <div>
          <span class="font-medium">Campaign ID:</span> <span id="results-campaign-id"></span>
        </div>
        <div>
          <span class="font-medium">Duration:</span> <span id="campaign-duration">0m</span>
        </div>
      </div>
      
      <!-- Hot Leads Section -->
      <div class="mb-8">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-900">üî• Hot Leads (<span id="hot-leads-summary">0</span>)</h3>
            <button 
              id="send-all-emails-btn-hot-leads-table"
              onclick="sendBulkEmails('hot-leads-table')" 
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"
            >
              Send all emails
            </button>
          </div>
        <p class="text-sm text-gray-600 mb-4">These leads match your ideal customer profile and are ready for immediate outreach.</p>
        
        <div id="hot-leads-table" class="mt-4"></div>
        
        <div class="mt-4 flex space-x-3">
          <button onclick="downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
            Export to Excel
          </button>
        </div>
      </div>
      
      <!-- Other Leads Section -->
      <div class="mb-8">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-900">üßä Other Leads (<span id="other-leads-summary">0</span>)</h3>
            <button 
              id="send-all-emails-btn-other-leads-table"
              onclick="sendBulkEmails('other-leads-table')" 
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"
            >
              Send all emails
            </button>
          </div>
        <p class="text-sm text-gray-600 mb-4">These leads require a nurturing sequence. Use the AI-generated email template below.</p>
        
        <div id="other-leads-table" class="mt-4"></div>
        
        <div class="mt-4 flex space-x-3">
          <button onclick="previewEmail()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
            Preview Email Template
          </button>
          
        </div>
      </div>
      
      <!-- History and New Campaign -->
      <div class="border-t border-gray-200 pt-6 flex justify-between items-center">
        <button onclick="exportHistory()" class="text-sm text-gray-500 hover:text-gray-700 font-medium">
          Export History
        </button>
        <button onclick="startNewCampaign()" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 px-4 rounded-lg transition-colors">
          Start New Campaign
        </button>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center text-sm text-gray-500 mt-12 py-4 border-t border-gray-200">
      ¬© 2025 Lead Generation Dashboard | Version 1.0.0 | <a href="#" class="text-blue-600 hover:text-blue-800">Documentation</a>
    </footer>
  </main>

  <script>
    // ========================================
    // CONFIGURATION SECTION
    // ========================================
    // !!! IMPORTANT !!! Replace with your actual n8n webhook URL
    const N8N_WEBHOOK_URL = 'https://primary-production-3af69.up.railway.app/webhook-test/NewLeadGen';
    const EMAIL_WEBHOOK_URL = 'YOUR_EMAIL_WEBHOOK_URL_HERE'; // New constant for email sending 
    // ========================================
    
    const STATUS_MESSAGES = {
      initializing: 'Initializing campaign...',
      scraping_linkedin: 'Scraping profiles...',
      enriching: 'Enriching lead data with AI...',
      scoring: 'AI scoring and classification...',
      generating_reports: 'Generating reports...',
      preparing_emails: 'Preparing personalized emails...',
      completed: 'Campaign completed. Results ready.'
    };

    const EMAIL_TEMPLATES = {
      english: {
        subject: "Quick question about {{business_name}}'s growth",
        body: `
          <p>Hi {{lead_name}},</p>
          <p>I noticed your company, <strong>{{business_name}}</strong>, in {{location}}. We specialize in helping companies like yours with their digital presence.</p>
          <p>Based on our analysis, we believe we can significantly help you with: <strong>{{service_suggestions}}</strong>.</p>
          <p>Would you be open to a quick 15-minute chat next week to discuss this further?</p>
          <p>You can book a time directly here: <a href="{{cta_link}}">{{cta_link}}</a></p>
          <p>Best regards,</p>
          <p>[Your Name]</p>
        `
      },
      spanish: {
        subject: "Una pregunta r√°pida sobre el crecimiento de {{business_name}}",
        body: `
          <p>Hola {{lead_name}},</p>
          <p>Not√© su empresa, <strong>{{business_name}}</strong>, en {{location}}. Nos especializamos en ayudar a empresas como la suya con su presencia digital.</p>
          <p>Seg√∫n nuestro an√°lisis, creemos que podemos ayudarle significativamente con: <strong>{{service_suggestions}}</strong>.</p>
          <p>¬øEstar√≠a abierto a una conversaci√≥n r√°pida de 15 minutos la pr√≥xima semana para discutir esto m√°s a fondo?</p>
          <p>Puede reservar una hora directamente aqu√≠: <a href="{{cta_link}}">{{cta_link}}</a></p>
          <p>Saludos cordiales,</p>
          <p>[Su Nombre]</p>
        `
      },
      french: {
        subject: "Une question rapide sur la croissance de {{business_name}}",
        body: `
          <p>Bonjour {{lead_name}},</p>
          <p>J'ai remarqu√© votre entreprise, <strong>{{business_name}}</strong>, √† {{location}}. Nous sommes sp√©cialis√©s dans l'aide aux entreprises comme la v√¥tre pour leur pr√©sence num√©rique.</p>
          <p>Sur la base de notre analyse, nous pensons pouvoir vous aider de mani√®re significative avec : <strong>{{service_suggestions}}</strong>.</p>
          <p>Seriez-vous disponible pour une courte discussion de 15 minutes la semaine prochaine pour en discuter davantage ?</p>
          <p>Vous pouvez r√©server un cr√©neau directement ici : <a href="{{cta_link}}">{{cta_link}}</a></p>
          <p>Cordialement,</p>
          <p>[Votre Nom]</p>
        `
      }
    };

    // Mock response structure for demo mode
    const MOCK_LEADS_RESPONSE = {
      summary: {
        total: 5,
        hot: 2,
        cold: 3,
        batch_id: "1",
        pipeline: "linkedin_profile_urls"
      },
      columns: [
        "lead_number", "type", "name", "handle", "url", "classification", "reach", "engagement_total", "relevance_score", "relevance_keywords"
      ],
      rows: [
        { "lead_number": 1, "type": "linkedin_profile_urls", "name": "Marie G", "handle": null, "url": "https://linkedin.com/in/marie-g", "classification": "Hot", "reach": 100, "engagement_total": 50, "relevance_score": 90, "relevance_keywords": ["AI", "SaaS"] },
        { "lead_number": 2, "type": "linkedin_profile_urls", "name": "Yu Bao", "handle": null, "url": "https://linkedin.com/in/yu-bao", "classification": "Cold", "reach": 50, "engagement_total": 10, "relevance_score": 40, "relevance_keywords": ["Fintech"] },
        { "lead_number": 3, "type": "linkedin_profile_urls", "name": "Brian LaReau", "handle": null, "url": "https://linkedin.com/in/brian-l", "classification": "Hot", "reach": 120, "engagement_total": 60, "relevance_score": 95, "relevance_keywords": ["Cloud", "DevOps"] },
        { "lead_number": 4, "type": "linkedin_profile_urls", "name": "Kento Matsuki", "handle": null, "url": "https://linkedin.com/in/kento-m", "classification": "Cold", "reach": 30, "engagement_total": 5, "relevance_score": 30, "relevance_keywords": ["Gaming"] },
        { "lead_number": 5, "type": "linkedin_profile_urls", "name": "Ravi Karamsetty", "handle": null, "url": "https://linkedin.com/in/ravi-k", "classification": "Cold", "reach": 80, "engagement_total": 20, "relevance_score": 55, "relevance_keywords": ["E-commerce"] }
      ]
    };

    // Global state object
    const state = {
      demoMode: false,
      currentCampaignId: null,
      campaignStartTime: null,
      timerInterval: null,
      progressInterval: null, // New interval for fake progress
      resultsData: null,
      lastCampaignData: null,
      campaignHistory: [],
      currentLanguage: 'english',
      uploadedFile: null,
      fileData: null,
      hotLeads: [],
      coldLeads: [],
      allLeads: []
    };

    // ========================================
    // CORE FUNCTIONS
    // ========================================

    function toggleDemoMode() {
      state.demoMode = document.getElementById('demo-mode').checked;
      showToast(state.demoMode ? 'Demo Mode Activated' : 'Demo Mode Deactivated', 'info');
    }

    function validateJSON() {
      const jsonInput = document.getElementById('campaign-json');
      const jsonError = document.getElementById('json-error');
      const runButton = document.getElementById('run-campaign-btn');
      
      try {
        JSON.parse(jsonInput.value);
        jsonError.classList.add('hidden');
        runButton.disabled = false;
      } catch (e) {
        jsonError.classList.remove('hidden');
        runButton.disabled = true;
      }
    }

    function loadSampleJSON() {
      const sample = {
        campaign_name: "Tech Startups NY",
        industry: "Technology",
        location: "New York, NY",
        company_size: "1-50",
        scraping_sources: [
          "linkedin",
          "company_website"
        ]
      };
      document.getElementById('campaign-json').value = JSON.stringify(sample, null, 2);
      validateJSON();
    }

    async function runCampaign() {
      const jsonInput = document.getElementById('campaign-json').value;
      const pipeline = document.getElementById('pipeline-select').value;
      
      try {
        const campaignData = JSON.parse(jsonInput);
        
        // Clear any previous campaign status/results
        if (state.timerInterval) clearInterval(state.timerInterval);
        if (state.progressInterval) clearInterval(state.progressInterval);
        document.getElementById('elapsed-time').textContent = '0:00';
        document.getElementById('progress-percentage').textContent = '0';
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('status-section').classList.remove('hidden');
        document.getElementById('results-section').classList.add('hidden');
        
        // Save to history
        state.lastCampaignData = { ...campaignData, pipeline };

        // Show status section
        document.getElementById('status-section').classList.remove('hidden');
        document.getElementById('results-section').classList.add('hidden');

        // Start tracking and simulated progress
        startCampaignTracking(generateCampaignId());

        if (state.demoMode) {
          // Demo mode - simulate campaign
          simulateCampaign();
        } else {
          // Real mode - call webhook
          // NOTE: Fixed timeout (AbortSignal.timeout) is removed as requested.
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              campaign: campaignData,
              pipeline: pipeline,
              timestamp: new Date().toISOString()
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Raw webhook response:', JSON.stringify(result, null, 2));
          
          // Extract leads from the webhook response
          const extractedData = extractResponseData(result);

          if (!extractedData) {
            console.error('Could not extract leads data from response. Response was:', result);
            throw new Error('Could not extract leads data from response');
          }

          console.log('‚úì Extracted leads data:', extractedData.length, 'items');

          // Process and complete the campaign immediately upon receiving the final data
          const processedResults = processLeadsData(extractedData);
          completeCampaign(processedResults);
        }

        showToast('Campaign started successfully!', 'success');

      } catch (e) {
        handleCampaignError(e.message);
        console.error('Campaign error:', e);
      }
    }

    function generateCampaignId() {
      return 'camp_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    function startCampaignTracking(campaignId) {
      state.currentCampaignId = campaignId;
      state.campaignStartTime = Date.now();
      
      document.getElementById('campaign-id').textContent = campaignId;
      updateStatus('running', 0, STATUS_MESSAGES.initializing);

      // Start elapsed time counter
      state.timerInterval = setInterval(updateElapsedTime, 1000);

      // Start simulated progress
      state.progressInterval = setInterval(updateSimulatedProgress, 1000);
    }

    function updateElapsedTime() {
      if (!state.campaignStartTime) return;
      
      const elapsed = Math.floor((Date.now() - state.campaignStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      document.getElementById('elapsed-time').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // New function for simulated progress
    function updateSimulatedProgress() {
      const steps = [
        { progress: 10, message: STATUS_MESSAGES.initializing },
        { progress: 25, message: STATUS_MESSAGES.scraping_linkedin },
        { progress: 45, message: STATUS_MESSAGES.enriching },
        { progress: 65, message: STATUS_MESSAGES.scoring },
        { progress: 80, message: STATUS_MESSAGES.generating_reports },
        { progress: 95, message: STATUS_MESSAGES.preparing_emails }
      ];

      const elapsedSeconds = Math.floor((Date.now() - state.campaignStartTime) / 1000);
      
      // Cycle through the steps based on elapsed time (e.g., change step every 10 seconds)
      const stepDuration = 10; // seconds per step
      const stepIndex = Math.min(Math.floor(elapsedSeconds / stepDuration), steps.length - 1);
      const currentStep = steps[stepIndex];
      
      // Calculate a fluctuating progress within the current step's range
      const minProgress = stepIndex > 0 ? steps[stepIndex - 1].progress : 0;
      const maxProgress = currentStep.progress;
      const timeInStep = elapsedSeconds % stepDuration;
      
      // Linear interpolation for progress, but cap at 95%
      let progress = Math.min(95, minProgress + (maxProgress - minProgress) * (timeInStep / stepDuration));
      
      // Add a small random fluctuation to make it look less robotic
      progress = Math.min(95, progress + Math.random() * 2);

      updateStatus('running', Math.floor(progress), currentStep.message);
    }

    function updateStatus(status, progress, message) {
      const indicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const progressBar = document.getElementById('progress-bar');
      const progressPct = document.getElementById('progress-percentage');
      const currentStep = document.getElementById('current-step');

      // Update status indicator color
      indicator.className = 'w-4 h-4 rounded-full';
      
      if (status === 'pending') {
        indicator.classList.add('bg-yellow-400');
        statusText.textContent = 'Pending';
      } else if (status === 'running') {
        indicator.classList.add('bg-blue-500', 'pulse-animation');
        statusText.textContent = 'Running';
      } else if (status === 'completed') {
        indicator.classList.add('bg-green-500');
        statusText.textContent = 'Completed';
      } else if (status === 'error') {
        indicator.classList.add('bg-red-500');
        statusText.textContent = 'Error';
      }

      // Update progress
      progressBar.style.width = `${progress}%`;
      progressPct.textContent = progress;

      // Update current step
      currentStep.textContent = message;
    }

    function simulateCampaign() {
      // Start tracking and simulated progress is already called in runCampaign()
      
      // Simulate a delay before the mock response is received
      setTimeout(() => {
        const extractedData = extractResponseData(MOCK_LEADS_RESPONSE);
        const processedResults = processLeadsData(extractedData);
        completeCampaign(processedResults);
      }, 15000); // 15 second delay to allow simulated progress to run
    }

    function completeCampaign(results) {
      // Stop timers and progress simulation
      if (state.timerInterval) clearInterval(state.timerInterval);
      if (state.progressInterval) clearInterval(state.progressInterval);

      updateStatus('completed', 100, STATUS_MESSAGES.completed);
      
      state.resultsData = results;

      // Calculate duration
      const duration = Math.floor((Date.now() - state.campaignStartTime) / 1000 / 60);

      // Save to history
      const historyEntry = {
        campaignId: state.currentCampaignId,
        timestamp: new Date().toISOString(),
        duration: `${duration}m`,
        results: results
      };
      
      state.campaignHistory.unshift(historyEntry);
      if (state.campaignHistory.length > 5) {
        state.campaignHistory = state.campaignHistory.slice(0, 5);
      }
      // Store in memory only (no localStorage in sandbox)
      updateLastCampaignSummary();

      // Display results
      displayResults(results, duration);
      
      showToast('Campaign completed successfully!', 'success');
    }

    function displayResults(results, duration) {
      console.log('Displaying results:', results);
      
      // Show results section
      document.getElementById('results-section').classList.remove('hidden');
      document.getElementById('status-section').classList.add('hidden'); // Hide status section

      // Update counts
      const hotCount = results.hot_leads?.count || 0;
      const otherCount = results.other_leads?.count || 0;
      const totalCount = results.total_leads || (hotCount + otherCount);
      
      document.getElementById('hot-leads-count').textContent = hotCount;
      document.getElementById('other-leads-count').textContent = otherCount;
      document.getElementById('total-leads').textContent = totalCount;
      document.getElementById('hot-leads-summary').textContent = hotCount;
      document.getElementById('other-leads-summary').textContent = otherCount;
      document.getElementById('campaign-duration').textContent = `${duration}m`;
      document.getElementById('results-campaign-id').textContent = state.currentCampaignId;

      // Render tables
      renderLeadsTable('hot-leads-table', results.hot_leads.leads, results.hot_leads.count);
      renderLeadsTable('other-leads-table', results.other_leads.leads, results.other_leads.count);
      // Initialize bulk button state after rendering tables
      updateBulkButtonState();

      // Scroll to results
      document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
    }

    function handleCampaignError(error) {
      if (state.timerInterval) clearInterval(state.timerInterval);
      if (state.progressInterval) clearInterval(state.progressInterval);

      updateStatus('error', 0, `Error: ${error}`);
      showToast(`Campaign failed: ${error}`, 'error');
    }

    function extractResponseData(rawData) {
      console.log('Extracting response data...', rawData);

      try {
        // Handle multiple webhook response formats

        // Format 1: Direct array of leads
        if (Array.isArray(rawData) && rawData.length > 0) {
          console.log('‚úì Direct array format:', rawData.length, 'items');
          return rawData;
        }

        // Format 2: {summary: {...}, rows: [...]} from your n8n webhook (THIS IS THE CORRECT FORMAT)
        if (rawData && typeof rawData === 'object' && Array.isArray(rawData.rows)) {
          console.log('‚úì Webhook format with rows:', rawData.rows.length, 'items');
          return rawData.rows;
        }

        // Format 3: {summary: {...}, columns: [...], rows: [...]}
        if (rawData && rawData.summary && Array.isArray(rawData.rows)) {
          console.log('‚úì Complete webhook format:', rawData.rows.length, 'items');
          return rawData.rows;
        }

        // Format 4: Nested AI response structure (Original, now less likely)
        if (Array.isArray(rawData) && rawData.length > 0) {
          const firstItem = rawData[0];

          if (firstItem.output && Array.isArray(firstItem.output)) {
            const output = firstItem.output[0];
            if (output.content && Array.isArray(output.content)) {
              const content = output.content[0];
              if (content.text && content.text.leads) {
                console.log('‚úì Nested AI format:', content.text.leads.length, 'items');
                return content.text.leads;
              }
            }
          }
        }

        // Format 5: Object with leads property
        if (rawData && typeof rawData === 'object' && Array.isArray(rawData.leads)) {
          console.log('‚úì Object with leads property:', rawData.leads.length, 'items');
          return rawData.leads;
        }

        console.warn('‚ö†Ô∏è Could not extract leads from response structure:', rawData);
        return null;
      } catch (e) {
        console.error('‚ùå Error extracting response data:', e);
        return null;
      }
    }

    function processLeadsData(leads) {
      console.log('Processing leads data:', leads, state.currentCampaignId);
      
      if (!leads || !Array.isArray(leads)) {
        console.error('Invalid leads data');
        return null;
      }

      // 1. Initialize emailSent status for all leads
      // Assign a unique leadId if missing, and initialize emailSent
      const processedLeads = leads.map((lead, index) => ({
        ...lead,
        leadId: lead.leadId || `${state.currentCampaignId}_${index}`, // Ensure a unique ID
        emailSent: false, // New field for idempotency
        // Add a default name if missing for display purposes
        name: lead.name || `Lead ${index + 1}`
      }));

      // Separate hot and cold leads (case-insensitive)
      const hotLeads = processedLeads.filter(lead => 
        lead.classification && lead.classification.toLowerCase() === 'hot'
      );
      
      const otherLeads = processedLeads.filter(lead => 
        !lead.classification || lead.classification.toLowerCase() !== 'hot'
      );

      console.log(`Processed: ${hotLeads.length} hot leads, ${otherLeads.length} other leads`);

      // Store leads in state for use in email functions and Excel export
      state.hotLeads = hotLeads;
      state.coldLeads = otherLeads; // Renamed to coldLeads for consistency with excel export function
      state.allLeads = processedLeads; // Store all leads for easy lookup and bulk processing

      return {
        hot_leads: {
          count: hotLeads.length,
          leads: hotLeads
        },
        other_leads: {
          count: otherLeads.length,
          leads: otherLeads,
          email_template_populated: true
        },
        total_leads: processedLeads.length,
        all_leads: processedLeads
      };
    }

    function renderLeadsTable(containerId, leads, totalCount) {
      const container = document.getElementById(containerId);
      if (!container) return;

      if (leads.length === 0) {
        container.innerHTML = `<p class="text-sm text-gray-500">No leads found for this category.</p>`;
        return;
      }

      const tableHtml = `
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Classification</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relevance Score</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keywords</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email sent</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${leads.map(lead => `
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name || 'N/A'}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${lead.classification && lead.classification.toLowerCase() === 'hot' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                      ${lead.classification || 'Other'}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.relevance_score || 'N/A'}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(lead.relevance_keywords || []).join(', ') || 'N/A'}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${lead.url ? `<a href="${lead.url}" target="_blank" class="text-indigo-600 hover:text-indigo-900">View</a>` : 'N/A'}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="email-sent-status-${lead.leadId}">
                      ${lead.emailSent ? '<span class="text-green-500 text-xl">‚úì</span>' : '‚Äî'}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${(lead.email && lead.email.includes('@')) ? 
                      `<button 
                        id="send-email-btn-${lead.leadId}"
                        onclick="sendSingleEmail('${lead.leadId}')" 
                        class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors ${lead.emailSent ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}"
                        ${lead.emailSent ? 'disabled' : ''}
                      >
                        Send email
                      </button>` : 
                      `<span class="text-xs text-red-500">No Email</span>`
                    }
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      container.innerHTML = tableHtml;
    }

    /*
    function downloadReport(format) {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      const url = format === 'word' ? 
        state.resultsData.hot_leads.word_report_url : 
        state.resultsData.hot_leads.pdf_report_url;

      if (state.demoMode) {
        showToast(`Demo mode: Would download ${format.toUpperCase()} report`, 'info');
      } else {
        window.open(url, '_blank');
        showToast(`Downloading ${format.toUpperCase()} report...`, 'success');
      }
    }
    */

    function downloadExcel() {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      const hotLeads = state.hotLeads || [];
      const coldLeads = state.coldLeads || [];

      if (hotLeads.length === 0 && coldLeads.length === 0) {
        showToast('No leads data available for export', 'error');
        return;
      }

      try {
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Hot leads sheet
        if (hotLeads.length > 0) {
          const hotData = hotLeads.map(lead => ({
            'Lead #': lead.lead_number,
            'Name': lead.name,
            'Classification': lead.classification,
            'URL': lead.url,
            'Reach': lead.reach,
            'Engagement Total': lead.engagement_total,
            'Relevance Score': lead.relevance_score,
            'Relevance Keywords': (lead.relevance_keywords || []).join(', ')
          }));
          const hotSheet = XLSX.utils.json_to_sheet(hotData);
          XLSX.utils.book_append_sheet(wb, hotSheet, 'Hot Leads');
        }
        
        // Cold leads sheet
        if (coldLeads.length > 0) {
          const coldData = coldLeads.map(lead => ({
            'Lead #': lead.lead_number,
            'Name': lead.name,
            'Classification': lead.classification || 'Other',
            'URL': lead.url,
            'Reach': lead.reach,
            'Engagement Total': lead.engagement_total,
            'Relevance Score': lead.relevance_score,
            'Relevance Keywords': (lead.relevance_keywords || []).join(', ')
          }));
          const coldSheet = XLSX.utils.json_to_sheet(coldData);
          XLSX.utils.book_append_sheet(wb, coldSheet, 'Other Leads');
        }
        
        // Summary sheet
        const totalLeads = hotLeads.length + coldLeads.length;
        const conversionRate = totalLeads > 0 ? Math.round((hotLeads.length / totalLeads) * 100) : 0;
        
        const summaryData = [
          { Metric: 'Total Leads', Value: totalLeads },
          { Metric: 'Hot Leads', Value: hotLeads.length },
          { Metric: 'Other Leads', Value: coldLeads.length },
          { Metric: 'Conversion Rate', Value: `${conversionRate}%` }
        ];
        const summarySheet = XLSX.utils.json_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
        
        // Download
        const timestamp = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `leads-report-${timestamp}.xlsx`);
        
        showToast('Excel report downloaded successfully!', 'success');
      } catch (e) {
        console.error('Error generating Excel:', e);
        showToast('Failed to generate Excel report: ' + e.message, 'error');
      }
    }

    function showPreviewSummary() {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      showToast(`Hot Leads Summary: ${state.resultsData.hot_leads.count} high-priority leads identified`, 'info');
    }

    function updateEmailLanguage() {
      state.currentLanguage = document.getElementById('email-language').value;
    }

    // ========================================
    // NEW EMAIL SENDING FUNCTIONS
    // ========================================

    // Helper to find a lead by ID
    function findLeadById(leadId) {
      return state.allLeads.find(lead => lead.leadId === leadId);
    }

    // Helper to update the UI for a single lead after a send attempt
    function updateLeadUI(leadId, success) {
      const lead = findLeadById(leadId);
      if (!lead) return;

      if (success) {
        lead.emailSent = true;
        // Update the tick icon
        const statusSpan = document.querySelector(`.email-sent-status-${leadId}`);
        if (statusSpan) {
          statusSpan.innerHTML = '<span class="text-green-500 text-xl">‚úì</span>';
        }
        // Disable the button
        const button = document.getElementById(`send-email-btn-${leadId}`);
        if (button) {
          button.disabled = true;
          button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
          button.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
        }
      }
      // Re-render the bulk button to update the eligible count
      updateBulkButtonState();
    }

    // Helper to update the bulk send button state (eligible count and disabled status)
    function updateBulkButtonState() {
      ['hot-leads-table', 'other-leads-table'].forEach(containerId => {
        const leads = containerId === 'hot-leads-table' ? state.hotLeads : state.coldLeads;
        const eligibleCount = leads.filter(l => l.email && l.email.includes('@') && !l.emailSent).length;
        const allButton = document.getElementById(`send-all-emails-btn-${containerId}`);

        if (allButton) {
          allButton.textContent = `Send all emails (${eligibleCount} eligible)`;
          if (eligibleCount === 0) {
            allButton.disabled = true;
            allButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
            allButton.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
          } else {
            allButton.disabled = false;
            allButton.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
            allButton.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
          }
        }
      });
    }

    // Helper to construct the metadata object
    function getLeadMetadata(lead) {
      // The requirement is to echo only the row fields currently rendered (e.g., url, classification)
      // The rendered fields are: name, classification, relevance_score, relevance_keywords, url
      return {
        url: lead.url || null,
        classification: lead.classification || null,
        relevance_score: lead.relevance_score || null,
        relevance_keywords: lead.relevance_keywords || null,
        // The original data structure might have other fields like lead_number, handle, type, reach, engagement_total
        // We will include them as they are part of the original lead object and might be useful
        lead_number: lead.lead_number || null,
        handle: lead.handle || null,
        type: lead.type || null,
        reach: lead.reach || null,
        engagement_total: lead.engagement_total || null,
      };
    }

    // Single Email Send Logic
    async function sendSingleEmail(leadId) {
      const lead = findLeadById(leadId);
      if (!lead || lead.emailSent || !lead.email || !lead.email.includes('@')) {
        showToast('Email already sent or no valid email address.', 'warning');
        return;
      }

      const button = document.getElementById(`send-email-btn-${leadId}`);
      if (button) button.disabled = true;

      const payload = {
        campaignId: state.currentCampaignId || 'N/A',
        leadId: lead.leadId,
        email: lead.email,
        name: lead.name || null,
        source: lead.type || null, // Assuming 'type' is the source
        emailLanguage: state.currentLanguage,
        metadata: getLeadMetadata(lead)
      };

      console.log('Single send payload:', payload);
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30-second timeout

        const response = await fetch(EMAIL_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (response.ok) {
          updateLeadUI(leadId, true);
          showToast('Email sent successfully!', 'success');
          console.log(`Single email sent for lead ${leadId}.`);
        } else {
          throw new Error(`HTTP Error: ${response.status}`);
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          showToast('Email send failed: Request timed out (30s).', 'error');
          console.error(`Email send failed for lead ${leadId}: Request timed out.`);
        } else {
          showToast(`Email send failed: ${e.message}`, 'error');
          console.error(`Email send failed for lead ${leadId}: ${e.message}`);
        }
        if (button) button.disabled = false; // Re-enable button on failure
      }
    }

    // Bulk Email Send Logic
    async function sendBulkEmails(containerId) {
      const leads = containerId === 'hot-leads-table' ? state.hotLeads : state.coldLeads;
      const eligibleLeads = leads.filter(l => l.email && l.email.includes('@') && !l.emailSent);
      
      if (eligibleLeads.length === 0) {
        showToast('No eligible emails to send.', 'warning');
        return;
      }

      const confirmed = confirm(`Send emails to ${eligibleLeads.length} eligible leads?`);
      if (!confirmed) return;

      const allButton = document.getElementById(`send-all-emails-btn-${containerId}`);
      if (allButton) allButton.disabled = true;

      let sentCount = 0;
      let failedCount = 0;
      let skippedCount = leads.length - eligibleLeads.length; // Already sent or no email

      const chunkSize = 100;
      const totalChunks = Math.ceil(eligibleLeads.length / chunkSize);
      
      const leadsToProcess = [...eligibleLeads]; // Clone the array to process

      for (let i = 0; i < totalChunks; i++) {
        const chunk = leadsToProcess.slice(i * chunkSize, (i + 1) * chunkSize);
        
        const bulkPayload = {
          campaignId: state.currentCampaignId || 'N/A',
          emailLanguage: state.currentLanguage,
          total: chunk.length,
          emails: chunk.map(lead => ({
            leadId: lead.leadId,
            email: lead.email,
            name: lead.name || null,
            source: lead.type || null,
            metadata: getLeadMetadata(lead)
          }))
        };

        console.log(`Bulk send: Processing chunk ${i + 1}/${totalChunks} with ${chunk.length} leads.`);
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30-second timeout

          const response = await fetch(EMAIL_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bulkPayload),
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            sentCount += chunk.length;
            chunk.forEach(lead => updateLeadUI(lead.leadId, true));
            console.log(`Chunk ${i + 1} sent successfully.`);
          } else {
            failedCount += chunk.length;
            console.error(`Chunk ${i + 1} failed with HTTP status: ${response.status}`);
          }
        } catch (e) {
          failedCount += chunk.length;
          if (e.name === 'AbortError') {
            console.error(`Chunk ${i + 1} failed: Request timed out (30s).`);
          } else {
            console.error(`Chunk ${i + 1} failed: ${e.message}`);
          }
        }
      }

      // Final summary toast
      const totalProcessed = sentCount + failedCount;
      const totalSkipped = skippedCount + (eligibleLeads.length - totalProcessed); // Should be 0 if logic is perfect, but safe to include
      
      showToast(`Bulk send complete: Sent: ${sentCount}, Failed: ${failedCount}, Skipped: ${totalSkipped}`, failedCount > 0 ? 'warning' : 'success');
      
      // Re-enable the button if there are still eligible leads (only if the failure was partial)
      updateBulkButtonState();
    }

    function previewEmail() {
      const language = state.currentLanguage;
      const template = EMAIL_TEMPLATES[language];

      // Sample lead data
      const sampleData = {
        lead_name: "John Smith",
        business_name: "Tech Innovations Inc",
        location: "New York, NY",
        service_suggestions: "Digital marketing strategy, SEO optimization, and social media management to increase your online presence and drive more qualified leads.",
        cta_link: "https://calendly.com/your-meeting-link"
      };

      let emailHtml = template.body;
      Object.keys(sampleData).forEach(key => {
        emailHtml = emailHtml.replace(new RegExp(`{{${key}}}`, 'g'), sampleData[key]);
      });

      const modalContent = document.getElementById('email-preview-content');
      modalContent.innerHTML = `
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">Subject:</h4>
          <p class="text-gray-900">${template.subject.replace('{{business_name}}', sampleData.business_name)}</p>
        </div>
        <div class="border-t pt-4">
          <h4 class="font-semibold text-gray-700 mb-2">Email Body:</h4>
          ${emailHtml}
        </div>
      `;

      document.getElementById('email-modal').classList.remove('hidden');
    }

    function closeEmailModal() {
      document.getElementById('email-modal').classList.add('hidden');
    }

    function copyEmailContent() {
      const language = state.currentLanguage;
      const template = EMAIL_TEMPLATES[language];
      
      const textContent = `Subject: ${template.subject}\n\n` + 
        template.body.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

      navigator.clipboard.writeText(textContent).then(() => {
        showToast('Email content copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy email content', 'error');
      });
    }

    // The original sendEmails function is now replaced by sendSingleEmail and sendBulkEmails.
    // The original button was removed in the previous phase.
    // Keeping the function body commented out for reference, but it is no longer used.
    /*
    async function sendEmails() {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      const confirmed = confirm(`Send emails to ${state.resultsData.other_leads.count} leads?`);
      if (!confirmed) return;

      if (state.demoMode) {
        showToast(`Demo mode: Would send ${state.resultsData.other_leads.count} emails`, 'info');
        return;
      }

      try {
        const response = await fetch(`${N8N_WEBHOOK_URL}/send-emails`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            campaignId: state.currentCampaignId,
            language: state.currentLanguage
          })
        });

        if (!response.ok) throw new Error('Failed to send emails');

        const result = await response.json();
        showToast(`Successfully sent ${result.emailsSent} emails`, 'success');
      } catch (e) {
        showToast(`Error sending emails: ${e.message}`, 'error');
      }
    }
    */

    function startNewCampaign() {
      // Reset state
      state.currentCampaignId = null;
      state.campaignStartTime = null;
      if (state.timerInterval) clearInterval(state.timerInterval);
      if (state.progressInterval) clearInterval(state.progressInterval);

      // Hide sections
      document.getElementById('status-section').classList.add('hidden');
      document.getElementById('results-section').classList.add('hidden');

      // Clear form
      document.getElementById('campaign-json').value = '';
      document.getElementById('campaign-file-upload').value = '';
      validateJSON();

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      showToast('Ready for new campaign', 'info');
    }

    function clearForm() {
      document.getElementById('campaign-json').value = '';
      document.getElementById('campaign-file-upload').value = '';
      validateJSON();
      showToast('Form cleared', 'info');
    }

    function duplicateLastCampaign() {
      if (!state.lastCampaignData) {
        showToast('No previous campaign to duplicate', 'error');
        return;
      }

      const { pipeline, ...campaignData } = state.lastCampaignData;
      
      document.getElementById('campaign-json').value = JSON.stringify(campaignData, null, 2);
      if (pipeline) {
        document.getElementById('pipeline-select').value = pipeline;
      }
      
      validateJSON();
      showToast('Last campaign duplicated', 'success');
    }

    function updateLastCampaignSummary() {
      if (state.campaignHistory.length === 0) return;

      const last = state.campaignHistory[0];
      const summaryDiv = document.getElementById('last-campaign-summary');
      const summaryText = document.getElementById('last-campaign-text');

      summaryText.textContent = `${last.campaignId} - ${last.results.total_leads} leads (${last.results.hot_leads.count} hot) - ${last.duration}`;
      summaryDiv.classList.remove('hidden');
    }

    function exportHistory() {
      if (state.campaignHistory.length === 0) {
        showToast('No campaign history to export', 'error');
        return;
      }

      const csv = [
        ['Campaign ID', 'Date', 'Duration', 'Total Leads', 'Hot Leads', 'Other Leads'].join(','),
        ...state.campaignHistory.map(entry => [
          entry.campaignId,
          new Date(entry.timestamp).toLocaleString(),
          entry.duration,
          entry.results.total_leads,
          entry.results.hot_leads.count,
          entry.results.other_leads.count
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `campaign-history-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Campaign history exported', 'success');
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };

      const toast = document.createElement('div');
      toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg max-w-sm`;
      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // File Upload and Conversion Functions
    async function handleCampaignFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (10MB max)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('File size must be less than 10MB', 'error');
        return;
      }

      // Validate file type
      const validExtensions = ['.json', '.csv', '.xlsx', '.xls', '.docx', '.doc'];
      const fileName = file.name.toLowerCase();
      const isValid = validExtensions.some(ext => fileName.endsWith(ext));
      
      if (!isValid) {
        showToast('Unsupported file type. Please upload JSON, CSV, Excel, or Word files.', 'error');
        return;
      }

      state.uploadedFile = file;

      // Show file analysis section
      document.getElementById('file-analysis-section').classList.remove('hidden');
      document.getElementById('file-preview').classList.add('hidden');
      document.getElementById('detected-data').classList.add('hidden');
      document.getElementById('conversion-results').classList.add('hidden');
      document.getElementById('conversion-status').classList.add('hidden');
      document.getElementById('use-conversion-btn').disabled = true;

      // Display file info
      const fileType = getFileType(fileName);
      const fileIcon = getFileIcon(fileType);
      
      document.getElementById('file-icon').textContent = fileIcon;
      document.getElementById('file-name-display').textContent = file.name;
      document.getElementById('file-size-display').textContent = formatFileSize(file.size);

      // Read and preview file
      try {
        await previewFile(file, fileType);
        showToast('File uploaded successfully. Click "Convert with AI" to process.', 'success');
      } catch (e) {
        showToast(`Error reading file: ${e.message}`, 'error');
      }
    }

    function getFileType(fileName) {
      if (fileName.endsWith('.json')) return 'json';
      if (fileName.endsWith('.csv')) return 'csv';
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) return 'xlsx';
      if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) return 'docx';
      return 'unknown';
    }

    function getFileIcon(fileType) {
      const icons = {
        json: 'üìÑ',
        csv: 'üìä',
        xlsx: 'üìà',
        docx: 'üìù'
      };
      return icons[fileType] || 'üìÑ';
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function previewFile(file, fileType) {
      const previewSection = document.getElementById('file-preview');
      const previewContent = document.getElementById('file-preview-content');

      if (fileType === 'json') {
        const text = await file.text();
        state.fileData = text;
        previewContent.textContent = text.substring(0, 500) + (text.length > 500 ? '...' : '');
        previewSection.classList.remove('hidden');
      } else if (fileType === 'csv') {
        const text = await file.text();
        state.fileData = text;
        const lines = text.split('\n').slice(0, 5);
        previewContent.innerHTML = lines.map(line => 
          `<div class="whitespace-nowrap overflow-x-auto">${escapeHtml(line)}</div>`
        ).join('');
        previewSection.classList.remove('hidden');
      } else if (fileType === 'xlsx') {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        state.fileData = btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)));
        
        const preview = jsonData.slice(0, 5).map(row => 
          row.slice(0, 5).join(' | ')
        ).join('\n');
        previewContent.textContent = preview + '\n...';
        previewSection.classList.remove('hidden');
      } else if (fileType === 'docx') {
        const arrayBuffer = await file.arrayBuffer();
        state.fileData = btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)));
        
        // For Word files, we'll show a placeholder since full text extraction requires complex parsing
        previewContent.textContent = '[Word document content - will be processed by AI]';
        previewSection.classList.remove('hidden');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // NOTE: The 'Convert with AI' button is removed from HTML, so this function is no longer called.
    // Keeping it for completeness if the user re-adds the button later.
    async function convertFile() {
      if (!state.uploadedFile) {
        showToast('No file uploaded', 'error');
        return;
      }

      const fileType = getFileType(state.uploadedFile.name.toLowerCase());
      
      // Show conversion status
      document.getElementById('conversion-status').classList.remove('hidden');
      document.getElementById('conversion-results').classList.add('hidden');
      // document.getElementById('convert-file-btn').disabled = true; // Button is removed

      if (state.demoMode) {
        // Demo mode - simulate conversion
        await simulateFileConversion(fileType);
      } else {
        // Real mode - call webhook
        await callConversionWebhook(fileType);
      }
    }

    async function simulateFileConversion(fileType) {
      const steps = [
        { progress: 20, text: 'üì§ Uploading file...', delay: 800 },
        { progress: 50, text: 'üîÑ Analyzing with AI...', delay: 1500 },
        { progress: 80, text: '‚öôÔ∏è Converting to campaign format...', delay: 1200 },
        { progress: 100, text: '‚úÖ Conversion completed!', delay: 500 }
      ];

      for (const step of steps) {
        document.getElementById('conversion-status-text').textContent = step.text;
        document.getElementById('conversion-progress-bar').style.width = step.progress + '%';
        await new Promise(resolve => setTimeout(resolve, step.delay));
      }

      // Simulate detected data
      document.getElementById('detected-campaign-name').textContent = 'Simulated Campaign';
      document.getElementById('detected-industry').textContent = 'Software';
      document.getElementById('detected-location').textContent = 'San Francisco';
      document.getElementById('detected-rows').textContent = '50';
      document.getElementById('detected-data').classList.remove('hidden');

      // Simulate converted JSON
      const convertedJSON = JSON.stringify({
        campaign_name: "Simulated Campaign",
        industry: "Software",
        location: "San Francisco",
        company_size: "51-200",
        scraping_sources: ["linkedin", "company_website"]
      }, null, 2);
      state.convertedJSON = convertedJSON;

      // Show results
      document.getElementById('conversion-results').classList.remove('hidden');
      document.getElementById('use-conversion-btn').disabled = false;
      // document.getElementById('convert-file-btn').disabled = false; // Button is removed
    }

    async function callConversionWebhook(fileType) {
      const formData = new FormData();
      formData.append('file', state.uploadedFile);
      formData.append('fileType', fileType);

      try {
        document.getElementById('conversion-status-text').textContent = 'üì§ Uploading file...';
        document.getElementById('conversion-progress-bar').style.width = '20%';

        const response = await fetch(`${N8N_WEBHOOK_URL}/convert-file`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        document.getElementById('conversion-status-text').textContent = 'üîÑ Analyzing with AI...';
        document.getElementById('conversion-progress-bar').style.width = '50%';

        const result = await response.json();

        document.getElementById('conversion-status-text').textContent = '‚öôÔ∏è Converting to campaign format...';
        document.getElementById('conversion-progress-bar').style.width = '80%';

        // Assuming the result contains the converted JSON and detected data
        const convertedJSON = result.converted_json;
        const detectedData = result.detected_data;

        if (!convertedJSON) {
          throw new Error('Conversion failed: No JSON returned.');
        }

        state.convertedJSON = convertedJSON;

        // Update detected data display
        document.getElementById('detected-campaign-name').textContent = detectedData.campaign_name || '-';
        document.getElementById('detected-industry').textContent = detectedData.industry || '-';
        document.getElementById('detected-location').textContent = detectedData.location || '-';
        document.getElementById('detected-rows').textContent = detectedData.rows || '-';
        document.getElementById('detected-data').classList.remove('hidden');

        document.getElementById('conversion-status-text').textContent = '‚úÖ Conversion completed!';
        document.getElementById('conversion-progress-bar').style.width = '100%';

        // Show results
        document.getElementById('conversion-results').classList.remove('hidden');
        document.getElementById('use-conversion-btn').disabled = false;
        // document.getElementById('convert-file-btn').disabled = false; // Button is removed
        showToast('File converted successfully!', 'success');

      } catch (e) {
        document.getElementById('conversion-status-text').textContent = '‚ùå Conversion failed!';
        document.getElementById('conversion-progress-bar').style.width = '0%';
        // document.getElementById('convert-file-btn').disabled = false; // Button is removed
        showToast(`Error converting file: ${e.message}`, 'error');
        console.error('Conversion error:', e);
      }
    }

    function useConvertedJSON() {
      if (state.convertedJSON) {
        document.getElementById('campaign-json').value = state.convertedJSON;
        validateJSON();
        document.getElementById('file-analysis-section').classList.add('hidden');
        document.getElementById('campaign-file-upload').value = '';
        showToast('Converted JSON loaded into configuration', 'success');
      } else {
        showToast('No converted JSON available', 'error');
      }
    }

    // Initial setup
    document.addEventListener('DOMContentLoaded', () => {
      validateJSON();
      loadSampleJSON();
      
      // Drag and drop functionality
      const dropZone = document.getElementById('file-drop-zone');
      const fileInput = document.getElementById('campaign-file-upload');

      dropZone.addEventListener('click', () => fileInput.click());
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults (e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
        dropZone.classList.add('border-blue-600', 'bg-blue-50');
      }

      function unhighlight() {
        dropZone.classList.remove('border-blue-600', 'bg-blue-50');
      }

      dropZone.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        fileInput.files = files;
        handleCampaignFileUpload({ target: fileInput });
      }
    });
  </script>
</body>
</html>
