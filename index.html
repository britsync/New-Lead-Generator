<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse-ring { animation: pulse-ring 2s infinite; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">

<script>
// ========================================
// âš ï¸ CONFIGURATION SECTION - EDIT THIS! âš ï¸
// ========================================
// Replace with your n8n webhook URL
const N8N_WEBHOOK_URL = 'https://primary-production-3af69.up.railway.app/webhook-test/NewLeadGen';
// Example: 'https://your-n8n-instance.com/webhook/lead-campaign'
// ========================================

const CONFIG = {
    webhookUrl: N8N_WEBHOOK_URL,
    pollInterval: 5000, // 5 seconds
};

let currentCampaignId = null;
let pollStatusInterval = null;
let campaignStartTime = null;
let isDemoMode = false;
let isRunning = false;

function showToast(message, type = 'info', duration = 5000) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
    };
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

function validateJSON(str) {
    try { JSON.parse(str); return true; } catch { return false; }
}

function updateJSONValidation() {
    const json = document.getElementById('campaignJson').value.trim();
    const errorElement = document.getElementById('jsonError');
    const runBtn = document.getElementById('runCampaignBtn');
    if (json === '') {
        errorElement.classList.add('hidden');
        runBtn.disabled = true;
        return;
    }
    if (validateJSON(json)) {
        errorElement.classList.add('hidden');
        runBtn.disabled = false;
    } else {
        errorElement.textContent = 'Invalid JSON. Please check your input format.';
        errorElement.classList.remove('hidden');
        runBtn.disabled = true;
    }
}

function updateStatusUI(status, progress = 0, step = '') {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentStep = document.getElementById('currentStep');

    if (status === 'pending') statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500';
    else if (status === 'running') statusIndicator.className = 'w-4 h-4 rounded-full bg-blue-500 pulse-ring';
    else if (status === 'completed') statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500';
    else if (status === 'error') statusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';

    statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    progressBar.style.width = progress + '%';
    progressText.textContent = progress + '%';
    currentStep.textContent = step || 'Processing...';
}

function startElapsedTimeCounter() {
    campaignStartTime = Date.now();
    const counter = setInterval(() => {
        if (isRunning) {
            const elapsed = Math.floor((Date.now() - campaignStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('elapsedTime').textContent = 
                `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
        } else {
            clearInterval(counter);
        }
    }, 1000);
}

async function triggerCampaign(campaignJson, pipeline) {
    if (!CONFIG.webhookUrl || CONFIG.webhookUrl === 'YOUR_N8N_WEBHOOK_URL_HERE') {
        showToast('âŒ ERROR: Webhook URL not configured! Edit line 20 in HTML', 'error', 8000);
        console.error('Webhook URL not configured');
        return null;
    }

    console.log('ðŸ“¤ Triggering campaign at:', CONFIG.webhookUrl);

    try {
        const response = await fetch(CONFIG.webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                campaign_json: JSON.parse(campaignJson),
                pipeline: pipeline,
                timestamp: new Date().toISOString()
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('âœ… Response from n8n:', data);
        return data;

    } catch (error) {
        console.error('âŒ Error:', error);
        showToast(`âŒ Error: ${error.message}`, 'error', 8000);
        return null;
    }
}

function displayResults(data) {
    document.getElementById('resultsSection').classList.remove('hidden');

    const hotLeads = data.hot_leads || { count: 0 };
    const otherLeads = data.other_leads || { count: 0 };
    const totalLeads = (hotLeads.count || 0) + (otherLeads.count || 0);

    document.getElementById('hotLeadsCount').textContent = hotLeads.count || 0;
    document.getElementById('otherLeadsCount').textContent = otherLeads.count || 0;
    document.getElementById('totalLeads').textContent = totalLeads;

    const conversionPotential = totalLeads > 0 ? Math.round((hotLeads.count / totalLeads) * 100) : 0;
    document.getElementById('conversionPotential').textContent = conversionPotential + '%';

    if (hotLeads.word_report_url) {
        document.getElementById('downloadWordBtn').onclick = () => {
            window.open(hotLeads.word_report_url, '_blank');
            showToast('ðŸ“„ Downloading Word report...', 'info');
        };
    }

    if (hotLeads.pdf_report_url) {
        document.getElementById('downloadPdfBtn').onclick = () => {
            window.open(hotLeads.pdf_report_url, '_blank');
            showToast('ðŸ“‘ Downloading PDF report...', 'info');
        };
    }

    if (campaignStartTime) {
        const duration = Math.floor((Date.now() - campaignStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        document.getElementById('campaignDuration').textContent = 
            `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
    }
}

function resetDashboard() {
    document.getElementById('campaignJson').value = '';
    document.getElementById('statusSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('runCampaignBtn').disabled = true;
    currentCampaignId = null;
    isRunning = false;
    updateJSONValidation();
}

async function runDemoMode() {
    currentCampaignId = 'demo-' + Math.random().toString(36).substr(2, 9);
    document.getElementById('campaignId').textContent = currentCampaignId;

    const statuses = [
        { status: 'running', progress: 10, step: 'Initializing campaign...' },
        { status: 'running', progress: 25, step: 'Scraping data sources...' },
        { status: 'running', progress: 50, step: 'Enriching leads with AI...' },
        { status: 'running', progress: 75, step: 'Scoring leads...' },
        { status: 'running', progress: 90, step: 'Generating reports...' },
        { status: 'completed', progress: 100, step: 'Campaign completed!' }
    ];

    for (const statusUpdate of statuses) {
        await new Promise(resolve => {
            setTimeout(() => {
                updateStatusUI(statusUpdate.status, statusUpdate.progress, statusUpdate.step);
                resolve();
            }, 2000);
        });
    }

    displayResults({
        hot_leads: { count: 15, word_report_url: '#', pdf_report_url: '#' },
        other_leads: { count: 45 }
    });

    showToast('âœ… Demo campaign completed!', 'success');
    isRunning = false;
}

document.addEventListener('DOMContentLoaded', () => {
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', darkModeToggle.checked);
    });

    if (localStorage.getItem('darkMode') === 'true') {
        darkModeToggle.checked = true;
        document.documentElement.classList.add('dark');
    }

    const demoModeToggle = document.getElementById('demoModeToggle');
    demoModeToggle.addEventListener('change', () => {
        isDemoMode = demoModeToggle.checked;
        if (isDemoMode) showToast('ðŸŽ® Demo mode enabled', 'info');
    });

    document.getElementById('campaignJson').addEventListener('input', updateJSONValidation);

    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-400');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-400'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400');
        const file = e.dataTransfer.files[0];
        if (file && (file.type === 'application/json' || file.name.endsWith('.json'))) {
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('campaignJson').value = event.target.result;
                updateJSONValidation();
                showToast('ðŸ“„ JSON file loaded', 'success');
            };
            reader.readAsText(file);
        }
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('campaignJson').value = event.target.result;
                updateJSONValidation();
                showToast('ðŸ“„ JSON file loaded', 'success');
            };
            reader.readAsText(file);
        }
    });

    document.getElementById('runCampaignBtn').addEventListener('click', async () => {
        const campaignJson = document.getElementById('campaignJson').value;
        const pipeline = document.getElementById('pipelineSelect').value;

        if (!validateJSON(campaignJson)) {
            showToast('âŒ Invalid JSON', 'error');
            return;
        }

        document.getElementById('statusSection').classList.remove('hidden');
        updateStatusUI('pending', 0, 'Initializing campaign...');
        isRunning = true;
        startElapsedTimeCounter();

        if (isDemoMode) {
            runDemoMode();
        } else {
            const response = await triggerCampaign(campaignJson, pipeline);
            if (response) {
                currentCampaignId = response.campaignId || response.campaign_id;
                document.getElementById('campaignId').textContent = currentCampaignId;
                showToast('âœ… Campaign triggered!', 'success');

                // If full results are in first response, display them
                if (response.hot_leads && response.other_leads) {
                    updateStatusUI('completed', 100, 'Campaign completed!');
                    displayResults(response);
                    isRunning = false;
                } else {
                    // Otherwise show that we're waiting for results
                    updateStatusUI('running', 50, 'Waiting for results...');
                }
            }
        }
    });

    document.getElementById('stopCampaignBtn').addEventListener('click', () => {
        clearInterval(pollStatusInterval);
        isRunning = false;
        showToast('â¹ï¸ Campaign stopped', 'warning');
    });

    document.getElementById('newCampaignBtn').addEventListener('click', () => {
        resetDashboard();
        window.scrollTo(0, 0);
    });
});
</script>

<div class="min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Lead Generation Dashboard</h1>
                    <p class="text-gray-600 dark:text-gray-300 italic mt-1">Upload campaign JSON and trigger n8n workflow</p>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-3">Dark</span>
                        <input type="checkbox" id="darkModeToggle" class="w-5 h-5 rounded">
                    </label>
                    <label class="flex items-center cursor-pointer bg-blue-50 dark:bg-blue-900 px-3 py-2 rounded">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Demo</span>
                        <input type="checkbox" id="demoModeToggle" class="w-5 h-5 rounded">
                    </label>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Campaign Upload -->
        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Campaign Configuration</h2>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Upload Campaign JSON</label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400" id="dropZone">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Drag and drop or <span class="text-blue-600 font-medium">click to browse</span></p>
                    <input type="file" id="fileInput" accept=".json" class="hidden">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Or Paste JSON</label>
                <textarea id="campaignJson" class="w-full h-48 p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg font-mono text-sm" placeholder="Paste your campaign JSON here..."></textarea>
                <p class="text-xs text-red-600 dark:text-red-400 mt-2 hidden" id="jsonError"></p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Pipeline</label>
                <select id="pipelineSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
                    <option value="linkedin">LinkedIn/Web Scraping</option>
                    <option value="google_maps">Google Maps Scraping</option>
                    <option value="social_media">Social Media Scraping</option>
                </select>
            </div>

            <button id="runCampaignBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Run Campaign
            </button>
        </section>

        <!-- Campaign Status -->
        <section id="statusSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden slide-in">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Campaign Status</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Campaign ID</p>
                    <p class="text-lg font-mono font-bold text-gray-900 dark:text-white" id="campaignId">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Elapsed Time</p>
                    <p class="text-lg font-bold text-gray-900 dark:text-white" id="elapsedTime">0s</p>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-4 h-4 rounded-full" id="statusIndicator"></div>
                    <span class="font-semibold text-gray-900 dark:text-white" id="statusText">Pending</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="currentStep">Waiting to start...</p>

                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-blue-600 h-3 w-0 transition-all duration-500"></div>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2" id="progressText">0%</p>
            </div>

            <button id="stopCampaignBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                Stop Campaign
            </button>
        </section>

        <!-- Results -->
        <section id="resultsSection" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">ðŸ”¥ Hot Leads</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Total Hot Leads</p>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400" id="hotLeadsCount">0</p>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Conversion Rate</p>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="conversionPotential">0%</p>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="downloadWordBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        ðŸ“„ Download Word
                    </button>
                    <button id="downloadPdfBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        ðŸ“‘ Download PDF
                    </button>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">ðŸ“§ Other Leads</h2>
                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="otherLeadsCount">0</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Campaign Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Total Leads</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalLeads">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Hot Leads</p>
                        <p class="text-2xl font-bold text-green-600" id="hotLeadsCount2">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Duration</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="campaignDuration">0m 0s</p>
                    </div>
                </div>
                <button id="newCampaignBtn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    Start New Campaign
                </button>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 text-center py-6 mt-12">
        <p class="text-sm">Â© 2025 Lead Generation Dashboard</p>
    </footer>
</div>

</body>
</html>
