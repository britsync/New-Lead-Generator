<!DOCTYPE html>
<html lang="en">
<!--
========================================
LEAD GENERATION DASHBOARD - SETUP GUIDE
========================================

Before using this dashboard, you MUST configure your n8n webhook URL:

1. Open this file (index.html) in a text editor (VS Code, Notepad++, Sublime Text, etc.)
2. Scroll down to the JavaScript section and find the "CONFIGURATION SECTION"
3. Replace 'YOUR_N8N_WEBHOOK_URL_HERE' with your actual n8n webhook URL
4. Save the file
5. Upload to GitHub Pages or your web hosting

Example webhook URL:
https://your-n8n-instance.com/webhook/lead-campaign

That's it! The dashboard will automatically use your configured webhook URL.
========================================
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Generation Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  
  <!-- Toast Notifications Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Email Preview Modal -->
  <div id="email-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="modal-backdrop fixed inset-0" onclick="closeEmailModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
          <h3 class="text-xl font-semibold text-gray-900">Email Preview</h3>
          <button onclick="closeEmailModal()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="email-preview-content" class="p-6"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Lead Generation Dashboard</h1>
        <p class="text-lg text-gray-600 italic">Upload your campaign data to trigger lead generation and get detailed reports</p>
      </div>
      
      <!-- Demo Mode Toggle -->
      <div class="mt-6 max-w-3xl mx-auto">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="demo-mode" onchange="toggleDemoMode()" class="rounded">
            <label for="demo-mode" class="text-sm text-gray-600">Demo Mode (use mock data for testing)</label>
          </div>
        </div>
      </div>

      <!-- Last Campaign Summary -->
      <div id="last-campaign-summary" class="mt-4 max-w-3xl mx-auto hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-gray-600">
          <span class="font-medium">Last Campaign:</span> <span id="last-campaign-text"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- File Upload Section -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">üì§ Upload Campaign File</h2>
      <p class="text-sm text-gray-600 mb-4">Upload any file format and let AI convert it to campaign configuration</p>
      
      <!-- Supported File Types -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìÑ</div>
          <div class="text-xs font-semibold text-gray-700">JSON</div>
          <div class="text-xs text-gray-500">Config file</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìä</div>
          <div class="text-xs font-semibold text-gray-700">CSV</div>
          <div class="text-xs text-gray-500">Spreadsheet</div>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìà</div>
          <div class="text-xs font-semibold text-gray-700">Excel</div>
          <div class="text-xs text-gray-500">.xlsx, .xls</div>
        </div>
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
          <div class="text-2xl mb-1">üìù</div>
          <div class="text-xs font-semibold text-gray-700">Word</div>
          <div class="text-xs text-gray-500">.docx, .doc</div>
        </div>
      </div>

      <!-- File Input with Drag & Drop -->
      <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer mb-4">
        <input
          type="file"
          id="campaign-file-upload"
          accept=".json,.csv,.xlsx,.xls,.docx,.doc"
          class="hidden"
          onchange="handleCampaignFileUpload(event)"
        />
        <div id="file-drop-content">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p class="text-sm text-gray-600 mb-1">Drag &amp; drop your file here, or <span class="text-blue-600 font-semibold">browse</span></p>
          <p class="text-xs text-gray-500">Supports JSON, CSV, Excel, Word (max 10MB)</p>
        </div>
      </div>

      <!-- File Analysis Preview -->
      <div id="file-analysis-section" class="hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <div id="file-icon" class="text-3xl">üìÑ</div>
              <div>
                <div class="font-semibold text-gray-900" id="file-name-display"></div>
                <div class="text-xs text-gray-500" id="file-size-display"></div>
              </div>
            </div>
            <button onclick="clearFileUpload()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Conversion Status -->
          <div id="conversion-status" class="hidden mb-3">
            <div class="flex items-center gap-2 text-sm">
              <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
              <span id="conversion-status-text" class="text-gray-700">üì§ Uploading file...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
              <div id="conversion-progress-bar" class="progress-bar h-full bg-blue-600 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <!-- File Preview -->
          <div id="file-preview" class="hidden">
            <div class="text-xs font-semibold text-gray-700 mb-2">File Preview:</div>
            <div id="file-preview-content" class="bg-white border border-gray-200 rounded p-3 text-xs font-mono max-h-40 overflow-auto"></div>
          </div>

          <!-- Detected Data -->
          <div id="detected-data" class="hidden mt-3">
            <div class="text-xs font-semibold text-gray-700 mb-2">Detected Information:</div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <span class="text-gray-500">Campaign Name:</span>
                <span id="detected-campaign-name" class="ml-1 font-medium text-gray-900">-</span>
              </div>
              <div>
                <span class="text-gray-500">Industry:</span>
                <span id="detected-industry" class="ml-1 font-medium text-gray-900">-</span>
              </div>
              <div>
                <span class="text-gray-500">Location:</span>
                <span id="detected-location" class="ml-1 font-medium text-gray-900">-</span>
              </div>
              <div>
                <span class="text-gray-500">Rows/Records:</span>
                <span id="detected-rows" class="ml-1 font-medium text-gray-900">-</span>
              </div>
            </div>
          </div>

          <!-- Conversion Results -->
          <div id="conversion-results" class="hidden mt-3">
            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm font-semibold text-green-800">‚úÖ Conversion Completed!</span>
              </div>
              <div class="grid grid-cols-3 gap-2 text-xs">
                <div>
                  <div class="text-gray-600">Data Quality</div>
                  <div id="data-quality" class="font-semibold text-gray-900">High</div>
                </div>
                <div>
                  <div class="text-gray-600">Confidence</div>
                  <div id="confidence-score" class="font-semibold text-gray-900">95%</div>
                </div>
                <div>
                  <div class="text-gray-600">Rows Processed</div>
                  <div id="rows-processed" class="font-semibold text-gray-900">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3">
          <button
            id="use-conversion-btn"
            onclick="useConvertedData()"
            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
            disabled
          >
            Use Conversion
          </button>
          <button
            id="convert-file-btn"
            onclick="convertFile()"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors"
          >
            Convert with AI
          </button>
        </div>
      </div>
    </div>

    <!-- Campaign Input Section -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Campaign Configuration</h2>
      
      <!-- Pipeline Selection -->
      <div class="mb-4">
        <label for="pipeline-select" class="block text-sm font-medium text-gray-700 mb-2">
          Select Pipeline
        </label>
        <select
          id="pipeline-select"
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="linkedin">LinkedIn/Web Scraping</option>
          <option value="google_maps">Google Maps Scraping</option>
          <option value="social_media">Social Media Scraping</option>
        </select>
      </div>

      <!-- JSON Input -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
          <label for="campaign-json" class="block text-sm font-medium text-gray-700">
            Campaign JSON
          </label>
          <button
            onclick="loadSampleJSON()"
            class="text-sm text-blue-600 hover:text-blue-800 font-medium"
          >
            Load Sample JSON
          </button>
        </div>
        <textarea
          id="campaign-json"
          rows="12"
          placeholder='Paste your campaign JSON here or use "Load Sample JSON"...'
          class="w-full px-4 py-3 border border-gray-300 rounded-md font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        ></textarea>
        <div id="json-error" class="mt-2 text-sm text-red-600 hidden"></div>
        <div id="json-success" class="mt-2 text-sm text-green-600 hidden">‚úì Valid JSON</div>
      </div>

      <!-- File Upload -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Or Upload Campaign JSON
        </label>
        <input
          type="file"
          id="json-file-upload"
          accept=".json"
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button
          id="run-campaign-btn"
          onclick="runCampaign()"
          disabled
          class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-md font-semibold text-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
        >
          Run Campaign
        </button>
        <button
          onclick="clearForm()"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300 transition-colors"
        >
          Clear
        </button>
        <button
          onclick="duplicateLastCampaign()"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300 transition-colors"
        >
          Duplicate Last
        </button>
      </div>
    </div>

    <!-- Campaign Status Section -->
    <div id="status-section" class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6 hidden">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Campaign Status</h2>
      
      <div class="space-y-4">
        <!-- Campaign ID and Timer -->
        <div class="flex justify-between items-center">
          <div>
            <span class="text-sm text-gray-600">Campaign ID:</span>
            <span id="campaign-id" class="ml-2 font-mono text-sm font-semibold text-gray-900"></span>
          </div>
          <div>
            <span class="text-sm text-gray-600">Elapsed Time:</span>
            <span id="elapsed-time" class="ml-2 font-mono text-sm font-semibold text-gray-900">0:00</span>
          </div>
        </div>

        <!-- Status Indicator -->
        <div class="flex items-center gap-3">
          <div id="status-indicator" class="w-4 h-4 rounded-full bg-gray-400"></div>
          <span id="status-text" class="text-lg font-medium text-gray-900">Pending</span>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div id="progress-bar" class="progress-bar h-full bg-blue-600 rounded-full" style="width: 0%"></div>
        </div>
        <div class="text-sm text-gray-600 text-right">
          <span id="progress-percentage">0</span>% Complete
        </div>

        <!-- Current Step -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="text-sm text-gray-600 mb-1">Current Step:</div>
          <div id="current-step" class="text-base font-medium text-gray-900">Initializing...</div>
        </div>

        <!-- Estimated Time Remaining -->
        <div class="text-sm text-gray-600">
          Estimated Time Remaining: <span id="time-remaining" class="font-semibold">Calculating...</span>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden">
      <div class="grid md:grid-cols-2 gap-6">
        
        <!-- Hot Leads -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
          <div class="flex items-center gap-2 mb-4">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <h2 class="text-2xl font-semibold text-gray-900">Hot Leads</h2>
          </div>
          
          <div class="mb-4">
            <div class="text-4xl font-bold text-green-600" id="hot-leads-count">0</div>
            <div class="text-sm text-gray-600">High-priority leads identified</div>
          </div>

          <div class="space-y-3">
            <button
              onclick="downloadReport('word')"
              class="w-full px-4 py-3 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Download Word Report
            </button>
            <button
              onclick="downloadReport('pdf')"
              class="w-full px-4 py-3 bg-red-600 text-white rounded-md font-medium hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
              </svg>
              Download PDF Report
            </button>
            <button
              onclick="downloadExcel()"
              class="w-full px-4 py-3 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Download Excel Report
            </button>
            <button
              onclick="showPreviewSummary()"
              class="w-full px-4 py-3 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300 transition-colors"
            >
              Preview Summary
            </button>
          </div>
        </div>

        <!-- Other Leads -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
          <div class="flex items-center gap-2 mb-4">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <h2 class="text-2xl font-semibold text-gray-900">Other Leads</h2>
          </div>
          
          <div class="mb-4">
            <div class="text-4xl font-bold text-blue-600" id="other-leads-count">0</div>
            <div class="text-sm text-gray-600">Leads for email outreach</div>
          </div>

          <!-- Language Selector -->
          <div class="mb-4">
            <label for="email-language" class="block text-sm font-medium text-gray-700 mb-2">
              Email Language
            </label>
            <select
              id="email-language"
              onchange="updateEmailLanguage()"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="ar">Arabic</option>
              <option value="de">German</option>
            </select>
          </div>

          <div class="space-y-3">
            <button
              onclick="previewEmail()"
              class="w-full px-4 py-3 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition-colors"
            >
              Preview Email
            </button>
            <button
              onclick="copyEmailContent()"
              class="w-full px-4 py-3 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300 transition-colors"
            >
              Copy Email Content
            </button>
            <button
              onclick="sendEmails()"
              class="w-full px-4 py-3 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
              Send Emails
            </button>
          </div>
        </div>
      </div>

      <!-- Campaign Summary -->
      <div class="mt-6 bg-white rounded-lg shadow-md border border-gray-200 p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Campaign Summary</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="text-2xl font-bold text-gray-900" id="total-leads">0</div>
            <div class="text-sm text-gray-600">Total Leads</div>
          </div>
          <div class="text-center p-4 bg-green-50 rounded-lg">
            <div class="text-2xl font-bold text-green-600" id="hot-leads-summary">0</div>
            <div class="text-sm text-gray-600">Hot Leads</div>
          </div>
          <div class="text-center p-4 bg-blue-50 rounded-lg">
            <div class="text-2xl font-bold text-blue-600" id="other-leads-summary">0</div>
            <div class="text-sm text-gray-600">Other Leads</div>
          </div>
          <div class="text-center p-4 bg-purple-50 rounded-lg">
            <div class="text-2xl font-bold text-purple-600" id="campaign-duration">0m</div>
            <div class="text-sm text-gray-600">Duration</div>
          </div>
        </div>
        
        <div class="mt-4 flex gap-3">
          <button
            onclick="startNewCampaign()"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition-colors"
          >
            Start New Campaign
          </button>
          <button
            onclick="exportHistory()"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300 transition-colors"
          >
            Export History
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center">
      <p class="text-sm text-gray-600">
        &copy; 2025 Lead Generation Dashboard | Version 1.0.0 | 
        <a href="#" class="text-blue-600 hover:text-blue-800">Documentation</a>
      </p>
    </div>
  </footer>

  <script>
    // ========================================
    // CONFIGURATION SECTION - EDIT THIS PART
    // ========================================
    // Replace 'YOUR_N8N_WEBHOOK_URL_HERE' with your actual n8n webhook URL
    // Example: const N8N_WEBHOOK_URL = 'https://your-n8n-instance.com/webhook/lead-campaign';
    const N8N_WEBHOOK_URL = 'https://primary-production-3af69.up.railway.app/webhook-test/NewLeadGen';
    // ========================================
    // END CONFIGURATION SECTION
    // ========================================

    // Application State
    let state = {
      demoMode: false,
      currentCampaignId: null,
      pollingInterval: null,
      campaignStartTime: null,
      timerInterval: null,
      lastCampaignData: null,
      campaignHistory: [],
      currentLanguage: 'en',
      resultsData: null,
      uploadedFile: null,
      fileData: null,
      convertedCampaignData: null,
      hotLeads: [],
      coldLeads: []
    };

    // Sample data for demo mode
    const MOCK_LEADS_RESPONSE = [
      {
        output: [
          {
            id: "msg_demo123",
            type: "message",
            status: "completed",
            content: [
              {
                type: "output_text",
                text: {
                  leads: [
                    {
                      lead_number: 1,
                      business_name: "Global Enterprises",
                      classification: "Hot",
                      lead_data: {
                        employees: 1200,
                        social_media_followers: 75000,
                        revenue: 20000000
                      }
                    },
                    {
                      lead_number: 2,
                      business_name: "Bright Future Ltd.",
                      classification: "Cold",
                      lead_data: {
                        employees: 40,
                        social_media_followers: 1500,
                        revenue: 800000
                      }
                    },
                    {
                      lead_number: 3,
                      business_name: "Innovative Solutions",
                      classification: "Hot",
                      lead_data: {
                        employees: 800,
                        social_media_followers: 95000,
                        revenue: 30000000
                      }
                    },
                    {
                      lead_number: 4,
                      business_name: "Tech Pioneers Inc",
                      classification: "Hot",
                      lead_data: {
                        employees: 500,
                        social_media_followers: 120000,
                        revenue: 15000000
                      }
                    },
                    {
                      lead_number: 5,
                      business_name: "Digital Dreams Co",
                      classification: "Cold",
                      lead_data: {
                        employees: 25,
                        social_media_followers: 800,
                        revenue: 500000
                      }
                    }
                  ]
                }
              }
            ]
          }
        ]
      }
    ];

    const SAMPLE_CAMPAIGN = {
      campaign_name: "Tech Startups NYC",
      target: {
        industry: "Technology",
        location: "New York, NY",
        company_size: "1-50"
      },
      scraping_sources: ["linkedin", "company_website"],
      enrichment: {
        enabled: true,
        ai_scoring: true
      },
      output_preferences: {
        hot_lead_threshold: 8,
        report_format: ["word", "pdf"],
        email_language: "english"
      }
    };

    const STATUS_MESSAGES = {
      initializing: "Initializing campaign...",
      scraping_linkedin: "Scraping LinkedIn profiles...",
      scraping_google_maps: "Scraping Google Maps data...",
      scraping_social: "Scraping social media profiles...",
      enriching: "Enriching leads with AI...",
      scoring: "Scoring and categorizing leads...",
      generating_reports: "Generating hot lead reports...",
      preparing_emails: "Preparing email templates...",
      completing: "Finalizing campaign...",
      completed: "Campaign completed successfully!"
    };

    const EMAIL_TEMPLATES = {
      en: {
        subject: "Exclusive Growth Opportunity for {{business_name}}",
        body: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #1F2937;">Hi {{lead_name}},</h2>
          <p style="color: #4B5563; line-height: 1.6;">I hope this email finds you well. I came across <strong>{{business_name}}</strong> in {{location}} and was impressed by your work.</p>
          <p style="color: #4B5563; line-height: 1.6;">Based on my research, I believe we could help you with:</p>
          <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #374151; margin: 0;">{{service_suggestions}}</p>
          </div>
          <p style="color: #4B5563; line-height: 1.6;">Would you be open to a brief conversation?</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="{{cta_link}}" style="background: #3B82F6; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;">Schedule a Call</a>
          </div>
          <p style="color: #6B7280; font-size: 14px;">Best regards,<br>Your Team</p>
        </div>`
      },
      es: {
        subject: "Oportunidad de Crecimiento Exclusiva para {{business_name}}",
        body: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #1F2937;">Hola {{lead_name}},</h2>
          <p style="color: #4B5563; line-height: 1.6;">Espero que este correo te encuentre bien. Encontr√© <strong>{{business_name}}</strong> en {{location}} y me impresion√≥ su trabajo.</p>
          <p style="color: #4B5563; line-height: 1.6;">Seg√∫n mi investigaci√≥n, creo que podr√≠amos ayudarle con:</p>
          <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #374151; margin: 0;">{{service_suggestions}}</p>
          </div>
          <p style="color: #4B5563; line-height: 1.6;">¬øEstar√≠a abierto a una breve conversaci√≥n?</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="{{cta_link}}" style="background: #3B82F6; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;">Programar una Llamada</a>
          </div>
          <p style="color: #6B7280; font-size: 14px;">Saludos cordiales,<br>Su Equipo</p>
        </div>`
      },
      fr: {
        subject: "Opportunit√© de Croissance Exclusive pour {{business_name}}",
        body: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #1F2937;">Bonjour {{lead_name}},</h2>
          <p style="color: #4B5563; line-height: 1.6;">J'esp√®re que ce courriel vous trouve bien. J'ai d√©couvert <strong>{{business_name}}</strong> √† {{location}} et j'ai √©t√© impressionn√© par votre travail.</p>
          <p style="color: #4B5563; line-height: 1.6;">Selon mes recherches, je pense que nous pourrions vous aider avec:</p>
          <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #374151; margin: 0;">{{service_suggestions}}</p>
          </div>
          <p style="color: #4B5563; line-height: 1.6;">Seriez-vous ouvert √† une br√®ve conversation?</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="{{cta_link}}" style="background: #3B82F6; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;">Planifier un Appel</a>
          </div>
          <p style="color: #6B7280; font-size: 14px;">Cordialement,<br>Votre √âquipe</p>
        </div>`
      },
      ar: {
        subject: "ŸÅÿ±ÿµÿ© ŸÜŸÖŸà ÿ≠ÿµÿ±Ÿäÿ© ŸÑŸÄ {{business_name}}",
        body: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; direction: rtl;">
          <h2 style="color: #1F2937;">ŸÖÿ±ÿ≠ÿ®ÿßŸã {{lead_name}}ÿå</h2>
          <p style="color: #4B5563; line-height: 1.6;">ÿ£ÿ™ŸÖŸÜŸâ ÿ£ŸÜ Ÿäÿ¨ÿØŸÉ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ®ÿÆŸäÿ±. ŸÑŸÇÿØ Ÿàÿ¨ÿØÿ™ <strong>{{business_name}}</strong> ŸÅŸä {{location}} Ÿàÿ£ÿπÿ¨ÿ®ÿ™ ÿ®ÿπŸÖŸÑŸÉŸÖ.</p>
          <p style="color: #4B5563; line-height: 1.6;">ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ®ÿ≠ÿ´Ÿäÿå ÿ£ÿπÿ™ŸÇÿØ ÿ£ŸÜŸÜÿß ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸÜÿ≥ÿßÿπÿØŸÉ ŸÅŸä:</p>
          <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #374151; margin: 0;">{{service_suggestions}}</p>
          </div>
          <p style="color: #4B5563; line-height: 1.6;">ŸáŸÑ ÿ≥ÿ™ŸÉŸàŸÜ ŸÖŸÜŸÅÿ™ÿ≠ÿßŸã ŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÇÿµŸäÿ±ÿ©ÿü</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="{{cta_link}}" style="background: #3B82F6; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;">ÿ¨ÿØŸàŸÑÿ© ŸÖŸÉÿßŸÑŸÖÿ©</a>
          </div>
          <p style="color: #6B7280; font-size: 14px;">ŸÖÿπ ÿ£ÿ∑Ÿäÿ® ÿßŸÑÿ™ÿ≠Ÿäÿßÿ™,<br>ŸÅÿ±ŸäŸÇŸÉ</p>
        </div>`
      },
      de: {
        subject: "Exklusive Wachstumschance f√ºr {{business_name}}",
        body: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #1F2937;">Hallo {{lead_name}},</h2>
          <p style="color: #4B5563; line-height: 1.6;">Ich hoffe, diese E-Mail erreicht Sie wohlauf. Ich bin auf <strong>{{business_name}}</strong> in {{location}} gesto√üen und war von Ihrer Arbeit beeindruckt.</p>
          <p style="color: #4B5563; line-height: 1.6;">Basierend auf meiner Recherche glaube ich, dass wir Ihnen helfen k√∂nnen mit:</p>
          <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <p style="color: #374151; margin: 0;">{{service_suggestions}}</p>
          </div>
          <p style="color: #4B5563; line-height: 1.6;">W√§ren Sie offen f√ºr ein kurzes Gespr√§ch?</p>
          <div style="text-align: center; margin: 30px 0;">
            <a href="{{cta_link}}" style="background: #3B82F6; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;">Anruf Planen</a>
          </div>
          <p style="color: #6B7280; font-size: 14px;">Mit freundlichen Gr√º√üen,<br>Ihr Team</p>
        </div>`
      }
    };

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      initializeEventListeners();
    });

    function loadSettings() {
      // Settings are maintained in memory only
      // No localStorage available in sandboxed environment
      
      // Validate webhook URL configuration
      if (N8N_WEBHOOK_URL === 'YOUR_N8N_WEBHOOK_URL_HERE') {
        console.warn('‚ö†Ô∏è Warning: N8N_WEBHOOK_URL is not configured. Please edit the CONFIGURATION SECTION in the code.');
      }
      
      updateLastCampaignSummary();
    }

    function initializeEventListeners() {
      // JSON textarea validation
      const jsonTextarea = document.getElementById('campaign-json');
      jsonTextarea.addEventListener('input', validateJSON);

      // File upload handler
      const fileUpload = document.getElementById('json-file-upload');
      fileUpload.addEventListener('change', handleFileUpload);

      // Pipeline selection (no persistence in sandbox)
      const pipelineSelect = document.getElementById('pipeline-select');
      pipelineSelect.addEventListener('change', () => {
        // Store in memory only
      });

      // Drag and drop for file upload
      const dropZone = document.getElementById('file-drop-zone');
      dropZone.addEventListener('click', () => {
        document.getElementById('campaign-file-upload').click();
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleCampaignFileUpload({ target: { files } });
        }
      });
    }



    function toggleDemoMode() {
      state.demoMode = document.getElementById('demo-mode').checked;
      if (state.demoMode) {
        showToast('Demo mode enabled - using mock data', 'info');
      }
    }

    function validateJSON() {
      const textarea = document.getElementById('campaign-json');
      const errorDiv = document.getElementById('json-error');
      const successDiv = document.getElementById('json-success');
      const runButton = document.getElementById('run-campaign-btn');

      const value = textarea.value.trim();
      
      if (!value) {
        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');
        runButton.disabled = true;
        return;
      }

      try {
        const parsed = JSON.parse(value);
        
        // Validate required fields
        const requiredFields = ['campaign_name', 'target', 'output_preferences'];
        const missingFields = requiredFields.filter(field => !parsed[field]);
        
        if (missingFields.length > 0) {
          throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
        }

        errorDiv.classList.add('hidden');
        successDiv.classList.remove('hidden');
        runButton.disabled = false;
      } catch (e) {
        errorDiv.textContent = `Invalid JSON: ${e.message}`;
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
        runButton.disabled = true;
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('campaign-json').value = e.target.result;
        validateJSON();
      };
      reader.readAsText(file);
    }

    function loadSampleJSON() {
      document.getElementById('campaign-json').value = JSON.stringify(SAMPLE_CAMPAIGN, null, 2);
      validateJSON();
      showToast('Sample JSON loaded', 'success');
    }

    async function runCampaign() {
      if (N8N_WEBHOOK_URL === 'YOUR_N8N_WEBHOOK_URL_HERE' && !state.demoMode) {
        showToast('Please configure N8N_WEBHOOK_URL in the code before running campaigns', 'error');
        return;
      }

      const jsonValue = document.getElementById('campaign-json').value;
      const pipeline = document.getElementById('pipeline-select').value;

      try {
        const campaignData = JSON.parse(jsonValue);
        
        // Save to history
        state.lastCampaignData = { ...campaignData, pipeline };

        // Show status section
        document.getElementById('status-section').classList.remove('hidden');
        document.getElementById('results-section').classList.add('hidden');

        if (state.demoMode) {
          // Demo mode - simulate campaign
          simulateCampaign();
        } else {
          // Real mode - call webhook
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              campaign: campaignData,
              pipeline: pipeline,
              timestamp: new Date().toISOString()
            }),
            signal: AbortSignal.timeout(30000) // 30 second timeout
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Raw webhook response:', JSON.stringify(result, null, 2));
          
          // Extract leads from nested structure: [0].output[0].content[0].text.leads
          const extractedData = extractResponseData(result);
          
          if (!extractedData) {
            throw new Error('Could not extract leads data from response');
          }
          startCampaignTracking(result.campaignId || generateCampaignId());
        }

        showToast('Campaign started successfully!', 'success');

      } catch (e) {
        showToast(`Error starting campaign: ${e.message}`, 'error');
        console.error('Campaign error:', e);
      }
    }

    function generateCampaignId() {
      return 'camp_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    function startCampaignTracking(campaignId) {
      state.currentCampaignId = campaignId;
      state.campaignStartTime = Date.now();
      
      document.getElementById('campaign-id').textContent = campaignId;
      updateStatus('running', 0, 'Initializing campaign...');

      // Start elapsed time counter
      state.timerInterval = setInterval(updateElapsedTime, 1000);

      // Start polling for status updates
      if (!state.demoMode) {
        state.pollingInterval = setInterval(() => pollCampaignStatus(campaignId), 5000);
      }
    }

    function updateElapsedTime() {
      if (!state.campaignStartTime) return;
      
      const elapsed = Math.floor((Date.now() - state.campaignStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      document.getElementById('elapsed-time').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    async function pollCampaignStatus(campaignId) {
      try {
        const response = await fetch(`${N8N_WEBHOOK_URL}/status/${campaignId}`);
        if (!response.ok) return;

        const status = await response.json();
        updateStatus(status.status, status.progress, status.currentStep);

        if (status.status === 'completed') {
          completeCampaign(status.results);
        } else if (status.status === 'error') {
          handleCampaignError(status.error);
        }
      } catch (e) {
        console.error('Polling error:', e);
      }
    }

    function updateStatus(status, progress, message) {
      const indicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const progressBar = document.getElementById('progress-bar');
      const progressPct = document.getElementById('progress-percentage');
      const currentStep = document.getElementById('current-step');

      // Update status indicator color
      indicator.className = 'w-4 h-4 rounded-full';
      
      if (status === 'pending') {
        indicator.classList.add('bg-yellow-400');
        statusText.textContent = 'Pending';
      } else if (status === 'running') {
        indicator.classList.add('bg-blue-500', 'pulse-animation');
        statusText.textContent = 'Running';
      } else if (status === 'completed') {
        indicator.classList.add('bg-green-500');
        statusText.textContent = 'Completed';
      } else if (status === 'error') {
        indicator.classList.add('bg-red-500');
        statusText.textContent = 'Error';
      }

      // Update progress
      progressBar.style.width = `${progress}%`;
      progressPct.textContent = progress;

      // Update current step
      currentStep.textContent = message;
    }

    function simulateCampaign() {
      const campaignId = generateCampaignId();
      startCampaignTracking(campaignId);

      const steps = [
        { progress: 10, message: STATUS_MESSAGES.initializing, delay: 1000 },
        { progress: 25, message: STATUS_MESSAGES.scraping_linkedin, delay: 3000 },
        { progress: 45, message: STATUS_MESSAGES.enriching, delay: 3000 },
        { progress: 65, message: STATUS_MESSAGES.scoring, delay: 2000 },
        { progress: 80, message: STATUS_MESSAGES.generating_reports, delay: 2000 },
        { progress: 95, message: STATUS_MESSAGES.preparing_emails, delay: 1500 },
        { progress: 100, message: STATUS_MESSAGES.completed, delay: 1000 }
      ];

      let currentStep = 0;
      
      function executeStep() {
        if (currentStep >= steps.length) {
          // Campaign complete - extract and process mock data
          const extractedData = extractResponseData(MOCK_LEADS_RESPONSE);
          const mockResults = processLeadsData(extractedData);
          completeCampaign(mockResults);
          return;
        }

        const step = steps[currentStep];
        updateStatus('running', step.progress, step.message);
        
        currentStep++;
        setTimeout(executeStep, step.delay);
      }

      executeStep();
    }

    function completeCampaign(results) {
      // Stop timers and polling
      if (state.timerInterval) clearInterval(state.timerInterval);
      if (state.pollingInterval) clearInterval(state.pollingInterval);

      updateStatus('completed', 100, STATUS_MESSAGES.completed);
      
      state.resultsData = results;

      // Calculate duration
      const duration = Math.floor((Date.now() - state.campaignStartTime) / 1000 / 60);

      // Save to history
      const historyEntry = {
        campaignId: state.currentCampaignId,
        timestamp: new Date().toISOString(),
        duration: `${duration}m`,
        results: results
      };
      
      state.campaignHistory.unshift(historyEntry);
      if (state.campaignHistory.length > 5) {
        state.campaignHistory = state.campaignHistory.slice(0, 5);
      }
      // Store in memory only (no localStorage in sandbox)
      updateLastCampaignSummary();

      // Display results
      displayResults(results, duration);
      
      showToast('Campaign completed successfully!', 'success');
    }

    function displayResults(results, duration) {
      console.log('Displaying results:', results);
      
      // Show results section
      document.getElementById('results-section').classList.remove('hidden');

      // Update counts
      const hotCount = results.hot_leads?.count || 0;
      const otherCount = results.other_leads?.count || 0;
      const totalCount = results.total_leads || (hotCount + otherCount);
      
      document.getElementById('hot-leads-count').textContent = hotCount;
      document.getElementById('other-leads-count').textContent = otherCount;
      document.getElementById('total-leads').textContent = totalCount;
      document.getElementById('hot-leads-summary').textContent = hotCount;
      document.getElementById('other-leads-summary').textContent = otherCount;
      document.getElementById('campaign-duration').textContent = `${duration}m`;

      // Scroll to results
      document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
    }

    function handleCampaignError(error) {
      if (state.timerInterval) clearInterval(state.timerInterval);
      if (state.pollingInterval) clearInterval(state.pollingInterval);

      updateStatus('error', 0, `Error: ${error}`);
      showToast(`Campaign failed: ${error}`, 'error');
    }

    function extractResponseData(rawData) {
      console.log('Extracting response data...');
      
      try {
        // Handle nested structure: [0].output[0].content[0].text.leads
        if (Array.isArray(rawData) && rawData.length > 0) {
          const firstItem = rawData[0];
          
          if (firstItem.output && Array.isArray(firstItem.output) && firstItem.output.length > 0) {
            const output = firstItem.output[0];
            
            if (output.content && Array.isArray(output.content) && output.content.length > 0) {
              const content = output.content[0];
              
              if (content.text && content.text.leads) {
                console.log('‚úì Extracted leads from nested structure:', content.text.leads.length);
                return content.text.leads;
              }
            }
          }
        }
        
        // Fallback: check if data is already in the correct format
        if (Array.isArray(rawData)) {
          console.log('‚úì Data is already in array format:', rawData.length);
          return rawData;
        }
        
        console.warn('‚ö†Ô∏è Could not extract leads from response structure');
        return null;
      } catch (e) {
        console.error('Error extracting response data:', e);
        return null;
      }
    }

    function processLeadsData(leads) {
      console.log('Processing leads data:', leads);
      
      if (!leads || !Array.isArray(leads)) {
        console.error('Invalid leads data');
        return null;
      }

      // Separate hot and cold leads (case-insensitive)
      const hotLeads = leads.filter(lead => 
        lead.classification && lead.classification.toLowerCase() === 'hot'
      );
      
      const coldLeads = leads.filter(lead => 
        !lead.classification || lead.classification.toLowerCase() !== 'hot'
      );

      console.log(`Processed: ${hotLeads.length} hot leads, ${coldLeads.length} cold leads`);

      // Store leads in state for Excel export
      state.hotLeads = hotLeads;
      state.coldLeads = coldLeads;

      return {
        hot_leads: {
          count: hotLeads.length,
          leads: hotLeads,
          word_report_url: "https://example.com/reports/hot-leads.docx",
          pdf_report_url: "https://example.com/reports/hot-leads.pdf"
        },
        other_leads: {
          count: coldLeads.length,
          leads: coldLeads,
          email_template_populated: true
        },
        total_leads: leads.length,
        all_leads: leads
      };
    }

    function downloadReport(format) {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      const url = format === 'word' ? 
        state.resultsData.hot_leads.word_report_url : 
        state.resultsData.hot_leads.pdf_report_url;

      if (state.demoMode) {
        showToast(`Demo mode: Would download ${format.toUpperCase()} report`, 'info');
      } else {
        window.open(url, '_blank');
        showToast(`Downloading ${format.toUpperCase()} report...`, 'success');
      }
    }

    function downloadExcel() {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      const hotLeads = state.hotLeads || [];
      const coldLeads = state.coldLeads || [];

      if (hotLeads.length === 0 && coldLeads.length === 0) {
        showToast('No leads data available for export', 'error');
        return;
      }

      try {
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Hot leads sheet
        if (hotLeads.length > 0) {
          const hotData = hotLeads.map(lead => ({
            'Lead #': lead.lead_number,
            'Business Name': lead.business_name,
            'Classification': lead.classification,
            'Employees': lead.lead_data.employees,
            'Social Followers': lead.lead_data.social_media_followers,
            'Revenue': lead.lead_data.revenue
          }));
          const hotSheet = XLSX.utils.json_to_sheet(hotData);
          XLSX.utils.book_append_sheet(wb, hotSheet, 'Hot Leads');
        }
        
        // Cold leads sheet
        if (coldLeads.length > 0) {
          const coldData = coldLeads.map(lead => ({
            'Lead #': lead.lead_number,
            'Business Name': lead.business_name,
            'Classification': lead.classification || 'Cold',
            'Employees': lead.lead_data.employees,
            'Social Followers': lead.lead_data.social_media_followers,
            'Revenue': lead.lead_data.revenue
          }));
          const coldSheet = XLSX.utils.json_to_sheet(coldData);
          XLSX.utils.book_append_sheet(wb, coldSheet, 'Cold Leads');
        }
        
        // Summary sheet
        const totalLeads = hotLeads.length + coldLeads.length;
        const conversionRate = totalLeads > 0 ? Math.round((hotLeads.length / totalLeads) * 100) : 0;
        
        const summaryData = [
          { Metric: 'Total Leads', Value: totalLeads },
          { Metric: 'Hot Leads', Value: hotLeads.length },
          { Metric: 'Cold Leads', Value: coldLeads.length },
          { Metric: 'Conversion Rate', Value: `${conversionRate}%` }
        ];
        const summarySheet = XLSX.utils.json_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
        
        // Download
        const timestamp = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `leads-report-${timestamp}.xlsx`);
        
        showToast('Excel report downloaded successfully!', 'success');
      } catch (e) {
        console.error('Error generating Excel:', e);
        showToast('Failed to generate Excel report: ' + e.message, 'error');
      }
    }

    function showPreviewSummary() {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      showToast(`Hot Leads Summary: ${state.resultsData.hot_leads.count} high-priority leads identified`, 'info');
    }

    function updateEmailLanguage() {
      state.currentLanguage = document.getElementById('email-language').value;
    }

    function previewEmail() {
      const language = state.currentLanguage;
      const template = EMAIL_TEMPLATES[language];

      // Sample lead data
      const sampleData = {
        lead_name: "John Smith",
        business_name: "Tech Innovations Inc",
        location: "New York, NY",
        service_suggestions: "Digital marketing strategy, SEO optimization, and social media management to increase your online presence and drive more qualified leads.",
        cta_link: "https://calendly.com/your-meeting-link"
      };

      let emailHtml = template.body;
      Object.keys(sampleData).forEach(key => {
        emailHtml = emailHtml.replace(new RegExp(`{{${key}}}`, 'g'), sampleData[key]);
      });

      const modalContent = document.getElementById('email-preview-content');
      modalContent.innerHTML = `
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">Subject:</h4>
          <p class="text-gray-900">${template.subject.replace('{{business_name}}', sampleData.business_name)}</p>
        <div id="hot-leads-table" class="mt-4"></div>
        </div>
        <div class="border-t pt-4">
          <h4 class="font-semibold text-gray-700 mb-2">Email Body:</h4>
          ${emailHtml}
        </div>
      `;

      document.getElementById('email-modal').classList.remove('hidden');
    }

    function closeEmailModal() {
      document.getElementById('email-modal').classList.add('hidden');
    }

    function copyEmailContent() {
      const language = state.currentLanguage;
      const template = EMAIL_TEMPLATES[language];
      
      const textContent = `Subject: ${template.subject}\n\n` + 
        template.body.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

      navigator.clipboard.writeText(textContent).then(() => {
        showToast('Email content copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy email content', 'error');
      });
    }

    async function sendEmails() {
      if (!state.resultsData) {
        showToast('No results available', 'error');
        return;
      }

      const confirmed = confirm(`Send emails to ${state.resultsData.other_leads.count} leads?`);
      if (!confirmed) return;

      if (state.demoMode) {
        showToast(`Demo mode: Would send ${state.resultsData.other_leads.count} emails`, 'info');
        return;
      }

      try {
        const response = await fetch(`${N8N_WEBHOOK_URL}/send-emails`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            campaignId: state.currentCampaignId,
            language: state.currentLanguage
          })
        });

        if (!response.ok) throw new Error('Failed to send emails');

        const result = await response.json();
        showToast(`Successfully sent ${result.emailsSent} emails`, 'success');
      } catch (e) {
        showToast(`Error sending emails: ${e.message}`, 'error');
      }
    }

    function startNewCampaign() {
      // Reset state
      state.currentCampaignId = null;
      state.campaignStartTime = null;
      state.resultsData = null;

      // Hide sections
      document.getElementById('status-section').classList.add('hidden');
      document.getElementById('results-section').classList.add('hidden');

      // Clear form
      document.getElementById('campaign-json').value = '';
      validateJSON();

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      showToast('Ready for new campaign', 'info');
    }

    function clearForm() {
      document.getElementById('campaign-json').value = '';
      document.getElementById('json-file-upload').value = '';
      validateJSON();
      showToast('Form cleared', 'info');
    }

    function duplicateLastCampaign() {
      if (!state.lastCampaignData) {
        showToast('No previous campaign to duplicate', 'error');
        return;
      }

      const { pipeline, ...campaignData } = state.lastCampaignData;
      
      document.getElementById('campaign-json').value = JSON.stringify(campaignData, null, 2);
      if (pipeline) {
        document.getElementById('pipeline-select').value = pipeline;
      }
      
      validateJSON();
      showToast('Last campaign duplicated', 'success');
    }

    function updateLastCampaignSummary() {
      if (state.campaignHistory.length === 0) return;

      const last = state.campaignHistory[0];
      const summaryDiv = document.getElementById('last-campaign-summary');
      const summaryText = document.getElementById('last-campaign-text');

      summaryText.textContent = `${last.campaignId} - ${last.results.total_leads} leads (${last.results.hot_leads.count} hot) - ${last.duration}`;
      summaryDiv.classList.remove('hidden');
    }

    function exportHistory() {
      if (state.campaignHistory.length === 0) {
        showToast('No campaign history to export', 'error');
        return;
      }

      const csv = [
        ['Campaign ID', 'Date', 'Duration', 'Total Leads', 'Hot Leads', 'Other Leads'].join(','),
        ...state.campaignHistory.map(entry => [
          entry.campaignId,
          new Date(entry.timestamp).toLocaleString(),
          entry.duration,
          entry.results.total_leads,
          entry.results.hot_leads.count,
          entry.results.other_leads.count
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `campaign-history-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Campaign history exported', 'success');
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };

      const toast = document.createElement('div');
      toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg max-w-sm`;
      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // File Upload and Conversion Functions
    async function handleCampaignFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (10MB max)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('File size must be less than 10MB', 'error');
        return;
      }

      // Validate file type
      const validExtensions = ['.json', '.csv', '.xlsx', '.xls', '.docx', '.doc'];
      const fileName = file.name.toLowerCase();
      const isValid = validExtensions.some(ext => fileName.endsWith(ext));
      
      if (!isValid) {
        showToast('Unsupported file type. Please upload JSON, CSV, Excel, or Word files.', 'error');
        return;
      }

      state.uploadedFile = file;

      // Show file analysis section
      document.getElementById('file-analysis-section').classList.remove('hidden');
      document.getElementById('file-preview').classList.add('hidden');
      document.getElementById('detected-data').classList.add('hidden');
      document.getElementById('conversion-results').classList.add('hidden');
      document.getElementById('conversion-status').classList.add('hidden');
      document.getElementById('use-conversion-btn').disabled = true;

      // Display file info
      const fileType = getFileType(fileName);
      const fileIcon = getFileIcon(fileType);
      
      document.getElementById('file-icon').textContent = fileIcon;
      document.getElementById('file-name-display').textContent = file.name;
      document.getElementById('file-size-display').textContent = formatFileSize(file.size);

      // Read and preview file
      try {
        await previewFile(file, fileType);
        showToast('File uploaded successfully. Click "Convert with AI" to process.', 'success');
      } catch (e) {
        showToast(`Error reading file: ${e.message}`, 'error');
      }
    }

    function getFileType(fileName) {
      if (fileName.endsWith('.json')) return 'json';
      if (fileName.endsWith('.csv')) return 'csv';
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) return 'xlsx';
      if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) return 'docx';
      return 'unknown';
    }

    function getFileIcon(fileType) {
      const icons = {
        json: 'üìÑ',
        csv: 'üìä',
        xlsx: 'üìà',
        docx: 'üìù'
      };
      return icons[fileType] || 'üìÑ';
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function previewFile(file, fileType) {
      const previewSection = document.getElementById('file-preview');
      const previewContent = document.getElementById('file-preview-content');

      if (fileType === 'json') {
        const text = await file.text();
        state.fileData = text;
        previewContent.textContent = text.substring(0, 500) + (text.length > 500 ? '...' : '');
        previewSection.classList.remove('hidden');
      } else if (fileType === 'csv') {
        const text = await file.text();
        state.fileData = text;
        const lines = text.split('\n').slice(0, 5);
        previewContent.innerHTML = lines.map(line => 
          `<div class="whitespace-nowrap overflow-x-auto">${escapeHtml(line)}</div>`
        ).join('');
        previewSection.classList.remove('hidden');
      } else if (fileType === 'xlsx') {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        state.fileData = btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)));
        
        const preview = jsonData.slice(0, 5).map(row => 
          row.slice(0, 5).join(' | ')
        ).join('\n');
        previewContent.textContent = preview + '\n...';
        previewSection.classList.remove('hidden');
      } else if (fileType === 'docx') {
        const arrayBuffer = await file.arrayBuffer();
        state.fileData = btoa(String.fromCharCode.apply(null, new Uint8Array(arrayBuffer)));
        
        // For Word files, we'll show a placeholder since full text extraction requires complex parsing
        previewContent.textContent = '[Word document content - will be processed by AI]';
        previewSection.classList.remove('hidden');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function convertFile() {
      if (!state.uploadedFile) {
        showToast('No file uploaded', 'error');
        return;
      }

      const fileType = getFileType(state.uploadedFile.name.toLowerCase());
      
      // Show conversion status
      document.getElementById('conversion-status').classList.remove('hidden');
      document.getElementById('conversion-results').classList.add('hidden');
      document.getElementById('convert-file-btn').disabled = true;

      if (state.demoMode) {
        // Demo mode - simulate conversion
        await simulateFileConversion(fileType);
      } else {
        // Real mode - call webhook
        await callConversionWebhook(fileType);
      }
    }

    async function simulateFileConversion(fileType) {
      const steps = [
        { progress: 20, text: 'üì§ Uploading file...', delay: 800 },
        { progress: 50, text: 'üîÑ Analyzing with AI...', delay: 1500 },
        { progress: 80, text: '‚öôÔ∏è Converting to campaign format...', delay: 1200 },
        { progress: 100, text: '‚úÖ Conversion completed!', delay: 500 }
      ];

      for (const step of steps) {
        document.getElementById('conversion-status-text').textContent = step.text;
        document.getElementById('conversion-progress-bar').style.width = step.progress + '%';
        await new Promise(resolve => setTimeout(resolve, step.delay));
      }

      // Simulate conversion result
      const mockResult = {
        success: true,
        campaign_json: {
          campaign_name: "Tech Startups NYC",
          target: {
            industry: "Technology",
            location: "New York, NY",
            company_size: "1-50"
          },
          scraping_sources: ["linkedin", "company_website"],
          enrichment: {
            enabled: true,
            ai_scoring: true
          },
          output_preferences: {
            hot_lead_threshold: 8,
            report_format: ["word", "pdf"],
            email_language: "english"
          }
        },
        conversion_status: "completed",
        file_analysis: {
          rows_processed: 150,
          data_quality: "high",
          confidence: 95
        }
      };

      displayConversionResults(mockResult);
    }

    async function callConversionWebhook(fileType) {
      if (N8N_WEBHOOK_URL === 'YOUR_N8N_WEBHOOK_URL_HERE') {
        showToast('Please configure N8N_WEBHOOK_URL in the code', 'error');
        document.getElementById('conversion-status').classList.add('hidden');
        document.getElementById('convert-file-btn').disabled = false;
        return;
      }

      try {
        const requestBody = {
          file_name: state.uploadedFile.name,
          file_type: fileType,
          file_data: state.fileData,
          timestamp: new Date().toISOString()
        };

        const response = await fetch(N8N_WEBHOOK_URL + '/convert-file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody),
          signal: AbortSignal.timeout(60000) // 60 second timeout
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        displayConversionResults(result);

      } catch (e) {
        showToast(`Conversion failed: ${e.message}`, 'error');
        document.getElementById('conversion-status').classList.add('hidden');
        document.getElementById('convert-file-btn').disabled = false;
      }
    }

    function displayConversionResults(result) {
      if (!result.success) {
        showToast('Conversion failed', 'error');
        document.getElementById('conversion-status').classList.add('hidden');
        document.getElementById('convert-file-btn').disabled = false;
        return;
      }

      state.convertedCampaignData = result.campaign_json;

      // Hide conversion status, show results
      document.getElementById('conversion-status').classList.add('hidden');
      document.getElementById('conversion-results').classList.remove('hidden');
      document.getElementById('detected-data').classList.remove('hidden');

      // Display detected data
      if (result.campaign_json) {
        document.getElementById('detected-campaign-name').textContent = 
          result.campaign_json.campaign_name || '-';
        document.getElementById('detected-industry').textContent = 
          result.campaign_json.target?.industry || '-';
        document.getElementById('detected-location').textContent = 
          result.campaign_json.target?.location || '-';
      }

      // Display file analysis
      if (result.file_analysis) {
        document.getElementById('data-quality').textContent = 
          result.file_analysis.data_quality || 'Unknown';
        document.getElementById('confidence-score').textContent = 
          (result.file_analysis.confidence || 0) + '%';
        document.getElementById('rows-processed').textContent = 
          result.file_analysis.rows_processed || 0;
        document.getElementById('detected-rows').textContent = 
          result.file_analysis.rows_processed || '-';
      }

      // Enable use conversion button
      document.getElementById('use-conversion-btn').disabled = false;
      document.getElementById('convert-file-btn').disabled = false;

      showToast('File converted successfully!', 'success');
    }

    function useConvertedData() {
      if (!state.convertedCampaignData) {
        showToast('No converted data available', 'error');
        return;
      }

      // Populate JSON textarea with converted data
      document.getElementById('campaign-json').value = 
        JSON.stringify(state.convertedCampaignData, null, 2);
      
      // Validate the JSON
      validateJSON();

      // Scroll to campaign configuration section
      document.querySelector('#campaign-json').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });

      showToast('Converted data loaded into campaign configuration', 'success');
    }

    function clearFileUpload() {
      state.uploadedFile = null;
      state.fileData = null;
      state.convertedCampaignData = null;
      
      document.getElementById('campaign-file-upload').value = '';
      document.getElementById('file-analysis-section').classList.add('hidden');
      document.getElementById('convert-file-btn').disabled = false;
      
      showToast('File upload cleared', 'info');
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeEmailModal();
      }
    });
  </script>

  <!-- Universal Lead Data Adapter -->
  <script>
    /** Incoming: array of flat rows (e.g., from your Google Sheet) */
    function renderDashboardWithData(rowsRaw) {
      const rows = Array.isArray(rowsRaw) ? rowsRaw : [];

      // Normalize keys: strip spaces, lowercase, convert to camel-like names
      const toKey = k => String(k || '')
        .trim()
        .replace(/\s+/g, '_')
        .replace(/[^\w]/g, '')
        .toLowerCase();

      const mapRow = (r) => {
        const x = {};
        for (const [k,v] of Object.entries(r)) x[toKey(k)] = v;
        // Canonical fields with robust fallbacks
        return {
          batch_id: x.batchid ?? x.batch_id ?? null,
          pipeline: x.pipeline ?? null,
          lead_number: Number(x.leadnumber ?? x.lead_number ?? x.leadid) || null,
          lead_id: x.leadid ?? null,
          type: x.type ?? null,
          name: x.name ?? null,
          handle: x.handle ?? null,
          url: x.url ?? x.website ?? null,
          classification: x.classification ?? null,
          reach: Number(x.reach ?? 0) || 0,
          engagement_total: Number(x.engagementtotal ?? x.engagement_total ?? 0) || 0,
          relevance_score: Number(x.relevancescore ?? 0) || 0,
          relevance_keywords: Array.isArray(x.relevancekeywords)
            ? x.relevancekeywords
            : String(x.relevancekeywords || '').split(',').map(s=>s.trim()).filter(Boolean),
        };
      };

      const data = rows.map(mapRow);

      // Metrics
      const total = data.length;
      const hot = data.filter(d => d.classification === 'Hot').length;
      const cold = data.filter(d => d.classification === 'Cold').length;

      // Write counts
      const setText = (sel, val) => { const el = document.querySelector(sel); if (el) el.textContent = String(val); };
      setText('#total-leads-count', total);
      setText('#hot-leads-count', hot);
      setText('#other-leads-count', cold);
      setText('#rows-processed', total);

      // Render simple tables
      const makeTable = (arr) => {
        if (!arr.length) return document.createElement('div');

        const cols = ['lead_number','type','name','handle','url','classification','reach','engagement_total','relevance_score'];
        const wrap = document.createElement('div');
        wrap.className = 'overflow-x-auto';
        const table = document.createElement('table');
        table.className = 'min-w-full divide-y divide-gray-200 mt-3';
        const thead = document.createElement('thead');
        thead.className = 'bg-gray-50';
        const trh = document.createElement('tr');
        cols.forEach(c => {
          const th = document.createElement('th');
          th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
          th.textContent = c.replace(/_/g,' ');
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        tbody.className = 'bg-white divide-y divide-gray-200';
        arr.forEach(r => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          cols.forEach(c => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 text-sm text-gray-900';
            let val = r[c];
            if (c === 'url' && val) {
              const a = document.createElement('a');
              a.href = val; a.textContent = 'View'; a.target = '_blank'; a.rel = 'noopener';
              a.className = 'text-indigo-600 hover:text-indigo-900';
              td.appendChild(a);
            } else {
              td.textContent = val == null ? '-' : String(val);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrap.appendChild(table);
        return wrap;
      };

      const hotData = data.filter(d => d.classification === 'Hot');
      const coldData = data.filter(d => d.classification === 'Cold');

      const mount = (sel, content) => {
        const el = document.querySelector(sel);
        if (el) { el.innerHTML = ''; el.appendChild(content); }
      };

      mount('#hot-leads-table', makeTable(hotData));
      mount('#other-leads-table', makeTable(coldData));

      console.log('Dashboard updated:', { total, hot, cold });
    }

    // Auto-wire: listen for webhook data or manual input
    window.addEventListener('DOMContentLoaded', () => {
      // If data is passed via query param or global variable
      if (window.LEAD_DATA) {
        renderDashboardWithData(window.LEAD_DATA);
      }

      // Example: wire a test button to load sample data
      const testBtn = document.getElementById('test-data-btn');
      if (testBtn) {
        testBtn.addEventListener('click', () => {
          const sampleData = [
            {"Batch ID":"1","Pipeline":"linkedin_profile_urls","Lead Number":1,"Lead ID":"1762969009571","Type":"linkedin_profile_urls","Source ID":"linkedin_profile_urls","Name":"Marie G","Classification":"Hot","Created At":"2025-11-12T12:36:49.571-05:00","Reach":0,"Engagement Total":0,"Likes":0,"Comments":0,"Shares":0},
            {"Batch ID":"2","Pipeline":"linkedin_profile_urls","Lead Number":2,"Lead ID":"1762969009575","Type":"linkedin_profile_urls","Source ID":"linkedin_profile_urls","Name":"Yu Bao","Classification":"Cold","Created At":"2025-11-12T12:36:49.574-05:00","Reach":0,"Engagement Total":0,"Likes":0,"Comments":0,"Shares":0}
          ];
          renderDashboardWithData(sampleData);
        });
      }
    });

    // Expose globally for external calls (e.g., from n8n webhook response)
    window.renderDashboardWithData = renderDashboardWithData;
  </script>

</body>
</html>
