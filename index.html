<!DOCTYPE html>
<html lang="en">
<!--
========================================
LEAD GENERATION DASHBOARD
========================================
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Generation Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
    /* Custom scrollbar for code blocks */
    textarea::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    textarea::-webkit-scrollbar-track {
      background: #f1f1f1; 
    }
    textarea::-webkit-scrollbar-thumb {
      background: #888; 
      border-radius: 4px;
    }
    textarea::-webkit-scrollbar-thumb:hover {
      background: #555; 
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  
  <!-- Toast Notifications Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Email Preview Modal -->
  <div id="email-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="modal-backdrop fixed inset-0" onclick="closeEmailModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center rounded-t-lg z-10">
          <h3 class="text-xl font-semibold text-gray-900">Email Template Preview</h3>
          <button onclick="closeEmailModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-0 flex-1 overflow-y-auto bg-gray-100">
            <!-- Iframe to isolate styles -->
            <iframe id="email-preview-iframe" class="w-full h-[600px] border-0"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Sending Progress Modal -->
  <div id="sending-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="modal-backdrop fixed inset-0"></div>
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full relative z-10 text-center">
        <div class="mb-6">
            <div class="mx-auto w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2" id="sending-title">Initiating Sequence...</h3>
        <p class="text-gray-600 mb-6" id="sending-status">Connecting to mail server...</p>
        
        <!-- Fake Progress Steps -->
        <div class="space-y-3 text-left text-sm text-gray-500 hidden" id="sending-steps">
            <div class="flex items-center gap-2" id="step-1">
                <i class="fas fa-circle-notch fa-spin text-blue-500"></i> <span>Preparing campaign data...</span>
            </div>
            <div class="flex items-center gap-2 hidden" id="step-2">
                <i class="fas fa-circle-notch fa-spin text-blue-500"></i> <span>Handshaking with email provider...</span>
            </div>
             <div class="flex items-center gap-2 hidden" id="step-3">
                <i class="fas fa-circle-notch fa-spin text-blue-500"></i> <span>Dispatching bulk request...</span>
            </div>
        </div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="bg-blue-600 text-white p-2 rounded-lg">
            <i class="fas fa-rocket text-xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Lead Gen <span class="text-blue-600">Dashboard</span></h1>
      </div>
      
      <div class="flex items-center gap-4">
         <div class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full border border-gray-200">
            <input type="checkbox" id="demo-mode" onchange="toggleDemoMode()" class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4 cursor-pointer">
            <label for="demo-mode" class="text-sm font-medium text-gray-700 cursor-pointer select-none">Demo Mode</label>
          </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Campaign Configuration Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6 transition-all hover:shadow-md">
      <div class="p-6 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
          <i class="fas fa-sliders-h text-gray-500"></i> Configuration
        </h2>
         <div class="flex space-x-3">
             <button onclick="loadSampleJSON()" class="text-sm text-blue-600 hover:text-blue-800 font-medium px-3 py-1.5 rounded-md hover:bg-blue-50 transition-colors">
                <i class="fas fa-magic mr-1"></i> Load Sample
             </button>
            <button onclick="clearForm()" class="text-sm text-gray-500 hover:text-gray-700 font-medium px-3 py-1.5 rounded-md hover:bg-gray-100 transition-colors">
                <i class="fas fa-trash-alt mr-1"></i> Clear
            </button>
        </div>
      </div>
      
      <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Settings -->
        <div class="space-y-6">
           <div>
            <label for="pipeline-select" class="block text-sm font-bold text-gray-700 mb-2">Select Pipeline Target</label>
            <div class="relative">
                <select id="pipeline-select" onchange="updatePipelineInJSON()" class="appearance-none w-full p-3 pl-4 pr-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow text-gray-700 font-medium">
                  <option value="google_maps_business_search">Google Maps Scrapper</option>
                  <option value="local_businesses">Businesses Scraper</option>
                  <option value="instagram_influencer_search">Social Media Scrapper</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                  <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle"></i> This updates the JSON configuration automatically.</p>
          </div>
          
          <div>
            <label for="email-language" class="block text-sm font-bold text-gray-700 mb-2">Email Language</label>
             <div class="relative">
                <select id="email-language" onchange="updateEmailLanguage()" class="appearance-none w-full p-3 pl-4 pr-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow text-gray-700 font-medium">
                  <option value="english">English üá∫üá∏</option>
                  <option value="spanish">Spanish üá™üá∏</option>
                  <option value="french">French üá´üá∑</option>
                </select>
                 <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                  <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>
          </div>

           <div class="pt-4">
                <button id="run-campaign-btn" onclick="runCampaign()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:shadow-xl transform transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                  <span>Run Campaign</span> <i class="fas fa-paper-plane"></i>
                </button>
           </div>
        </div>

        <!-- Right Column: JSON Input -->
        <div class="lg:col-span-2">
          <label for="campaign-json" class="block text-sm font-bold text-gray-700 mb-2 flex justify-between">
              <span>Campaign JSON Payload</span>
              <span id="json-status" class="text-xs font-normal text-gray-500">Ready</span>
          </label>
          <div class="relative group">
              <textarea
                id="campaign-json"
                rows="16"
                class="w-full p-4 bg-gray-50 border border-gray-300 rounded-lg font-mono text-xs leading-relaxed focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none resize-none text-gray-800 shadow-inner"
                spellcheck="false"
                oninput="validateJSON()"
              ></textarea>
              <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button onclick="copyJSON()" class="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500 hover:text-blue-600">Copy</button>
              </div>
          </div>
          <div id="json-error" class="text-red-500 text-xs mt-2 hidden flex items-center gap-1"><i class="fas fa-exclamation-triangle"></i> Invalid JSON format.</div>
        </div>
      </div>
    </div>

    <!-- Campaign Status Section -->
    <div id="status-section" class="hidden bg-white rounded-xl shadow-md border border-gray-200 p-8 mb-6 text-center relative overflow-hidden">
      <!-- Background decoration -->
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500"></div>
      
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Campaign In Progress</h2>
      <p class="text-gray-500 mb-8">Orchestrating workflow execution...</p>
      
      <div class="max-w-2xl mx-auto">
          <div class="relative pt-1">
            <div class="flex mb-2 items-center justify-between">
              <div>
                <span id="status-text" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                  Initializing
                </span>
              </div>
              <div class="text-right">
                <span id="progress-percentage" class="text-xs font-semibold inline-block text-blue-600">
                  0%
                </span>
              </div>
            </div>
            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-100">
              <div id="progress-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500 ease-out"></div>
            </div>
          </div>
          
          <div id="terminal-log" class="mt-6 bg-gray-900 rounded-lg p-4 text-left font-mono text-xs text-green-400 h-32 overflow-y-auto shadow-inner border border-gray-700">
              <div class="opacity-50">> System ready.</div>
          </div>
      </div>
    </div>

    <!-- Campaign Results Section -->
    <div id="results-section" class="hidden space-y-6">
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-center justify-between border-l-4 border-green-500">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Hot Leads</p>
                <p class="text-3xl font-bold text-gray-900 mt-1" id="hot-leads-count">0</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full text-green-600">
                <i class="fas fa-fire text-xl"></i>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-center justify-between border-l-4 border-blue-500">
             <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Other Leads</p>
                <p class="text-3xl font-bold text-gray-900 mt-1" id="other-leads-count">0</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                <i class="fas fa-snowflake text-xl"></i>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex items-center justify-between border-l-4 border-gray-500">
             <div>
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Found</p>
                <p class="text-3xl font-bold text-gray-900 mt-1" id="total-leads">0</p>
            </div>
            <div class="bg-gray-100 p-3 rounded-full text-gray-600">
                <i class="fas fa-list text-xl"></i>
            </div>
        </div>
      </div>
      
      <!-- Results Tables Container -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="border-b border-gray-200">
             <nav class="-mb-px flex" aria-label="Tabs">
                <button id="tab-hot" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-green-500 text-green-600 hover:text-green-800 hover:border-green-600 focus:outline-none transition-colors" onclick="switchTab('hot')">
                   üî• Hot Leads (<span id="tab-hot-count">0</span>)
                </button>
                <button id="tab-other" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none transition-colors" onclick="switchTab('other')">
                   ‚ùÑÔ∏è Other Leads (<span id="tab-other-count">0</span>)
                </button>
            </nav>
        </div>

        <div class="p-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
             <h3 class="text-lg font-medium text-gray-900" id="current-view-title">Hot Leads</h3>
             <div class="flex gap-3">
                 <button onclick="previewEmailTemplate()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-eye mr-2"></i> Preview Email
                </button>
                 <button id="send-all-btn" onclick="sendAllEmails()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-paper-plane mr-2"></i> Send all Emails
                </button>
             </div>
        </div>
        
        <div class="overflow-x-auto">
             <div id="hot-leads-view" class="block">
                <div id="hot-leads-table" class="min-w-full"></div>
             </div>
             <div id="other-leads-view" class="hidden">
                <div id="other-leads-table" class="min-w-full"></div>
             </div>
        </div>
      </div>

      <!-- Footer Action -->
      <div class="flex justify-end">
        <button onclick="startNewCampaign()" class="text-gray-600 hover:text-gray-900 font-medium text-sm flex items-center gap-1">
            <i class="fas fa-redo"></i> Start New Campaign
        </button>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center text-xs text-gray-400 mt-12 py-4 border-t border-gray-200">
      Lead Gen Dashboard v2.1
    </footer>
  </main>

  <script>
    // ========================================
    // CONFIGURATION & STATE
    // ========================================
    const N8N_WEBHOOK_URL = 'https://primary-production-3af69.up.railway.app/webhook-test/NewLeadGen';
    const EMAIL_SEND_WEBHOOK = 'https://primary-production-3af69.up.railway.app/webhook/email_send'; 
    
    const state = {
      demoMode: false,
      currentTab: 'hot',
      hotLeads: [],
      otherLeads: [],
      allLeads: [],
      pipeline: 'google_maps_business_search',
      emailHtml: '' // Will store the loaded email template
    };

    // Email template storage - This would normally be loaded from file, 
    // but we'll embed it in variable for the preview logic based on the uploaded file content.
    let emailTemplateContent = ``; // Will be populated

    // ========================================
    // UI INTERACTION FUNCTIONS
    // ========================================

    function toggleDemoMode() {
      state.demoMode = document.getElementById('demo-mode').checked;
      showToast(state.demoMode ? 'Demo Mode Activated' : 'Demo Mode Deactivated', 'info');
    }

    function switchTab(tab) {
        state.currentTab = tab;
        document.getElementById('tab-hot').className = tab === 'hot' 
            ? "w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-green-500 text-green-600" 
            : "w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors cursor-pointer";
            
        document.getElementById('tab-other').className = tab === 'other' 
            ? "w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-blue-500 text-blue-600" 
            : "w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors cursor-pointer";
        
        document.getElementById('hot-leads-view').className = tab === 'hot' ? 'block' : 'hidden';
        document.getElementById('other-leads-view').className = tab === 'other' ? 'block' : 'hidden';
        
        document.getElementById('current-view-title').textContent = tab === 'hot' ? 'Hot Leads' : 'Other Leads';
    }

    function updatePipelineInJSON() {
        const select = document.getElementById('pipeline-select');
        const selectedPipeline = select.value;
        state.pipeline = selectedPipeline;
        
        // Try to update JSON if valid
        const jsonStr = document.getElementById('campaign-json').value;
        try {
            if (jsonStr.trim()) {
                let jsonObj = JSON.parse(jsonStr);
                jsonObj.pipeline = selectedPipeline;
                document.getElementById('campaign-json').value = JSON.stringify(jsonObj, null, 2);
                validateJSON();
            } else {
                // If empty, load the sample immediately
                loadSampleJSON();
            }
        } catch (e) {
            // If invalid JSON, just warn but don't break logic
            // We won't force update invalid JSON
        }
    }
    
    function updateEmailLanguage() {
        // Placeholder for language selection logic if needed in future
        // Currently just visual selection
    }

    function validateJSON() {
      const jsonInput = document.getElementById('campaign-json');
      const jsonError = document.getElementById('json-error');
      const runButton = document.getElementById('run-campaign-btn');
      const status = document.getElementById('json-status');
      
      try {
        if(jsonInput.value.trim() === "") throw new Error("Empty");
        JSON.parse(jsonInput.value);
        jsonError.classList.add('hidden');
        jsonInput.classList.remove('border-red-500');
        jsonInput.classList.add('border-gray-300');
        runButton.disabled = false;
        status.innerHTML = '<span class="text-green-500"><i class="fas fa-check-circle"></i> Valid</span>';
      } catch (e) {
        if (jsonInput.value.trim() !== "") {
            jsonError.classList.remove('hidden');
            jsonInput.classList.add('border-red-500');
            jsonInput.classList.remove('border-gray-300');
            runButton.disabled = true;
            status.innerHTML = '<span class="text-red-500">Invalid</span>';
        } else {
            runButton.disabled = true;
             status.innerHTML = 'Empty';
        }
      }
    }

    function copyJSON() {
        const textarea = document.getElementById('campaign-json');
        textarea.select();
        document.execCommand('copy');
        showToast('JSON copied to clipboard', 'success');
        window.getSelection().removeAllRanges();
    }

    function loadSampleJSON() {
      const pipeline = document.getElementById('pipeline-select').value;
      let sample = {};

      // Sample based on pipeline as requested
      if (pipeline === "google_maps_business_search") {
          sample = {
            "pipeline": "google_maps_business_search",
            "campaign_name": "Local Gyms London",
            "queries": ["gyms in London", "fitness centers London"],
            "max_results": 20
          };
      } else if (pipeline === "local_businesses") {
          sample = {
            "pipeline": "local_businesses",
            "campaign_name": "Plumbers Manchester",
            "location": "Manchester, UK",
            "category": "Plumber",
            "radius_km": 10
          };
      } else if (pipeline === "instagram_influencer_search") {
           sample = {
            "pipeline": "instagram_influencer_search",
            "campaign_name": "Beauty Influencers",
            "hashtags": ["#beauty", "#makeup"],
            "min_followers": 5000
          };
      } else {
          // Fallback
           sample = {
            "pipeline": pipeline,
            "campaign_name": "Generic Campaign"
          };
      }
      
      document.getElementById('campaign-json').value = JSON.stringify(sample, null, 2);
      validateJSON();
    }

    // ========================================
    // EMAIL PREVIEW LOGIC
    // ========================================
    
    // We put the template content here directly to ensure it works without external fetch
    const RAW_EMAIL_TEMPLATE = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Audit Report ‚Äì {{CompanyName}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body, table, td, p, a {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      }
      img { border: 0; outline: none; text-decoration: none; display: block; }
      a { text-decoration: none; }
    </style>
  </head>
  <body style="margin:0; padding:0; background-color:#e5f0ff;">
    <div style="padding: 40px; text-align: center; color: #666; font-family: sans-serif;">
        [Email Template Preview Mode]<br><br>
        This preview renders the 'emailTemplate.html' structure.<br>
        Variables like {{CompanyName}} would be replaced in a real send.
    </div>
    <!-- In a real app, this would be the full HTML from the uploaded file -->
    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="background-color:#e5f0ff;">
      <tr>
        <td align="center" style="padding:24px 12px;">
          <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="max-width:600px; background-color:#ffffff; border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(15,23,42,0.08);">
            <tr>
              <td style="background:linear-gradient(135deg,#eff6ff,#bfdbfe 40%,#60a5fa 100%); padding:22px 22px 18px 22px; color:#0f172a;">
                  <h1 style="margin:0; font-size:22px; line-height:1.4; color:#0f172a;">
                    Audit Report ‚Äì {{CompanyName}}
                  </h1>
              </td>
            </tr>
            <tr>
              <td style="padding:22px 24px 8px 24px; background-color:#ffffff;">
                <p style="font-size:14px; line-height:1.7; color:#4b5563;">
                  Hi {{Name}},<br><br>We‚Äôve just completed an independent audit on {{CompanyName}}. This is a preview of the email template.
                </p>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </body>
</html>`;

    function previewEmailTemplate() {
        const modal = document.getElementById('email-modal');
        const iframe = document.getElementById('email-preview-iframe');
        
        modal.classList.remove('hidden');
        
        // Write the template into the iframe
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(RAW_EMAIL_TEMPLATE);
        doc.close();
    }

    function closeEmailModal() {
        document.getElementById('email-modal').classList.add('hidden');
    }


    // ========================================
    // CAMPAIGN EXECUTION LOGIC
    // ========================================

    async function runCampaign() {
      const jsonInput = document.getElementById('campaign-json').value;
      const pipeline = document.getElementById('pipeline-select').value;
      
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('results-section').classList.add('hidden');
      
      // Reset Logs and Progress
      const logContainer = document.getElementById('terminal-log');
      logContainer.innerHTML = '<div class="opacity-50">> Initializing campaign...</div>';
      updateProgress(5, 'Initializing', 'Connecting to workflow...');
      
      try {
        const campaignData = JSON.parse(jsonInput);

        if (state.demoMode) {
          simulateCampaignExecution(pipeline);
          return;
        }
        
        // Real Execution with Stream Reading
        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            campaign: campaignData,
            pipeline: pipeline,
            timestamp: new Date().toISOString()
          })
        });

        // 1. Get Stream Reader
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = ''; // Stores full raw response (Text + JSON)

        // 2. Read loop
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            // Decode chunk
            const chunk = decoder.decode(value, { stream: true });
            buffer += chunk;
            
            // 3. Check for live events in this chunk
            if (chunk.includes("Getting Leads...üî•")) {
                updateProgress(20, "Getting Leads...üî•", "Scraping targets...");
                logToTerminal("Getting Leads...üî•");
            }
            
            if (chunk.includes("Ranking Hot Leads...üî•üî•üî•")) {
                updateProgress(50, "Ranking Hot Leads...üî•üî•üî•", "AI analysis in progress...");
                logToTerminal("Ranking Hot Leads...üî•üî•üî•");
            }
            
            // Check for "Saving Leads... (N)"
            // Regex matches: Saving Leads in Google sheet...üî•üî•üî•(123)
            const savingMatch = chunk.match(/Saving Leads in Google sheet\.\.\.üî•üî•üî•\((\d+)\)/);
            if (savingMatch) {
                 const count = savingMatch[1];
                 const msg = `Saving Leads in Google sheet...üî•üî•üî•(${count})`;
                 updateProgress(80, msg, `Processing batch #${count}`);
                 logToTerminal(msg); 
            }
        }
        
        // 4. Stream Finished: Flush & Extract JSON
        buffer += decoder.decode(); // Flush any remaining bytes
        
        // Robust JSON Extractor
        // Look for the LAST occurrence of '[' or '{' just in case there is prefix text
        // But usually we want the first occurrence of the *structure* after text logs.
        
        let jsonStartIndex = buffer.indexOf('[');
        let objStartIndex = buffer.indexOf('{');
        
        // We try to find the earliest valid JSON start
        let startIndex = -1;
        if (jsonStartIndex !== -1 && objStartIndex !== -1) {
            startIndex = Math.min(jsonStartIndex, objStartIndex);
        } else if (jsonStartIndex !== -1) {
            startIndex = jsonStartIndex;
        } else {
            startIndex = objStartIndex;
        }

        if (startIndex !== -1) {
            // Extract everything from that point to the end
            const jsonString = buffer.substring(startIndex);
            try {
                const result = JSON.parse(jsonString);
                // 5. Process Final Results
                processResults(result, pipeline);
            } catch (e) {
                console.warn("JSON Parse Error, attempting cleanup:", e);
                // Soft error - Log but don't crash UI
                logToTerminal("Warning: Data format irregular. Attempting to display raw response.", "text-yellow-400");
                logToTerminal("Raw Buffer: " + buffer.substring(0, 100) + "...", "text-gray-500");
            }
        } else {
            // SOFT FALLBACK: Do not throw Error.
            // If we got text updates but no JSON, maybe it's just finished?
            // We log the raw buffer to the terminal so the user can see what happened
            console.warn("Buffer content:", buffer);
            
            if (buffer.includes("Getting Leads") || buffer.includes("Ranking")) {
                 // We assume success but no data returned yet (maybe waiting?)
                 logToTerminal("Stream ended. No JSON data detected in final response.", "text-yellow-400");
                 logToTerminal("Raw response received: " + buffer, "text-gray-400");
                 updateProgress(100, "Completed (No Data)", "Workflow finished without returning leads.");
            } else {
                 logToTerminal("Workflow completed with no structured data.", "text-red-400");
            }
        }

      } catch (e) {
        // Only catch network errors here
        logToTerminal('Network Error: ' + e.message, 'text-red-500');
        showToast('Connection issue: ' + e.message, 'error');
      }
    }
    
    // Visual simulation of the specific text steps requested (Demo Mode)
    function simulateWebhookProgressSteps() {
        let steps = [
            { pct: 20, msg: "Getting Leads...üî•" },
            { pct: 50, msg: "Ranking Hot Leads...üî•üî•üî•" },
            { pct: 80, msg: "Saving Leads in Google sheet...üî•üî•üî•(1)" }
        ];
        
        let i = 0;
        let interval = setInterval(() => {
            if (i >= steps.length) {
                clearInterval(interval);
                return;
            }
            updateProgress(steps[i].pct, steps[i].msg, "Processing...");
            logToTerminal(steps[i].msg);
            i++;
        }, 1500); // Update every 1.5s
    }

    function simulateCampaignExecution(pipeline) {
        // Mock data based on pipeline
        simulateWebhookProgressSteps();
        
        setTimeout(() => {
            let mockData = [];
            if (pipeline === 'google_maps_business_search') {
                mockData = [
                     { "lead_number": 1, "business_name": "Tech Corp", "classification": "Hot", "email": "contact@tech.com", "phone": "123456", "website_url": "http://tech.com", "rating": 4.5 },
                     { "lead_number": 2, "business_name": "Old Bakery", "classification": "Cold", "email": "", "phone": "987654", "website_url": "http://bakery.com", "rating": 3.2 }
                ];
            } else if (pipeline === 'instagram_influencer_search') {
                 mockData = [
                     { "Lead Number": 1, "Name": "Sara Beauty", "Classification": "Hot", "email": "sara@social.com", "URLs": ["http://insta.com/sara"], "Avg ER": 0.05 },
                     { "Lead Number": 2, "Name": "John Doe", "Classification": "Cold", "email": "john@gmail.com", "URLs": ["http://insta.com/john"], "Avg ER": 0.01 }
                ];
            } else {
                // Local business mock
                 mockData = [
                     { "lead_number": 1, "business_name": "Fast Plumbers", "classification": "Hot", "email": "info@plumb.com", "website_url": "http://plumb.com" },
                     { "lead_number": 2, "business_name": "Slow Fix", "classification": "Cold", "email": "admin@fix.com", "website_url": "http://fix.com" }
                ];
            }
            
            processResults(mockData, pipeline);
        }, 5000);
    }

    function updateProgress(percent, status, detail) {
        document.getElementById('progress-bar').style.width = `${percent}%`;
        document.getElementById('progress-percentage').textContent = `${percent}%`;
        document.getElementById('status-text').textContent = status;
    }

    function logToTerminal(msg, colorClass = 'text-green-400') {
        const log = document.getElementById('terminal-log');
        const entry = document.createElement('div');
        entry.className = `mb-1 ${colorClass}`;
        entry.textContent = `> ${msg}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    // ========================================
    // RESULT PROCESSING & RENDERING
    // ========================================

    function processResults(data, pipeline) {
        updateProgress(100, 'Completed', 'Rendering dashboard...');
        
        // Data Normalization based on format
        // We handle the 3 formats provided: Companies, Gmaps, SocialMedia
        
        // Check structure. The incoming data might be { rows: [...] } or just [...]
        let rows = Array.isArray(data) ? data : (data.rows || data.leads || []);
        
        if (rows.length === 0) {
            showToast("No leads found in response", "error");
            return;
        }

        let hot = [];
        let other = [];
        
        // Normalization Map
        // We map diverse keys to a standard set for display: Name, Class, Email, Link, Extra1
        const normalized = rows.map(row => {
            // Detect Format
            let std = { original: row };
            
            // Determine Classification (Case insensitive)
            let cls = (row.classification || row.Classification || 'Cold').toLowerCase();
            std.isHot = cls.includes('hot');
            std.classification = row.classification || row.Classification || cls;
            
            // Determine Name
            std.name = row.business_name || row.Name || row.title || "Unknown";
            
            // Determine Email (string or array)
            let rawEmail = row.email || row.emails || row.Email || "";
            std.email = Array.isArray(rawEmail) ? rawEmail[0] : rawEmail;
            
            // Determine URL
            let rawUrl = row.website_url || row.website || row.URLs || row.url || "";
            std.url = Array.isArray(rawUrl) ? rawUrl[0] : rawUrl;
            
            return std;
        });

        hot = normalized.filter(i => i.isHot);
        other = normalized.filter(i => !i.isHot);
        
        state.hotLeads = hot;
        state.otherLeads = other;
        state.allLeads = normalized;

        // Update Counts
        document.getElementById('hot-leads-count').textContent = hot.length;
        document.getElementById('tab-hot-count').textContent = hot.length;
        document.getElementById('other-leads-count').textContent = other.length;
        document.getElementById('tab-other-count').textContent = other.length;
        document.getElementById('total-leads').textContent = normalized.length;

        // Render Tables
        renderTable('hot-leads-table', hot, pipeline);
        renderTable('other-leads-table', other, pipeline);

        // Show Results
        setTimeout(() => {
            document.getElementById('status-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('results-section').offsetTop, behavior: 'smooth' });
        }, 1000);
    }

    function renderTable(containerId, data, pipeline) {
        const container = document.getElementById(containerId);
        if (data.length === 0) {
            container.innerHTML = `<div class="p-8 text-center text-gray-500">No leads in this category.</div>`;
            return;
        }

        // Dynamic Columns based on pipeline/format
        // We stripped Action, Relevance Score, Keywords as requested
        let headers = ['Name', 'Classification', 'Email', 'Link'];
        
        // Add specific columns based on pipeline context found in data
        // Check first item to see what we have
        const sample = data[0].original;
        
        let extraColKey = null;
        let extraColLabel = "";

        if (sample.hasOwnProperty('Avg ER')) {
             headers.push('Engagement Rate');
             extraColKey = 'Avg ER';
        } else if (sample.hasOwnProperty('primary_phone_number')) {
             headers.push('Phone');
             extraColKey = 'primary_phone_number';
        }

        let html = `
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
        `;

        data.forEach(row => {
            let linkHtml = row.url ? `<a href="${row.url}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fas fa-external-link-alt"></i></a>` : `<span class="text-gray-400">-</span>`;
            let emailHtml = row.email ? `<span class="text-gray-700">${row.email}</span>` : `<span class="text-gray-400 text-xs italic">None</span>`;
            let badgeColor = row.isHot ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
            
            let extraVal = "";
            if(extraColKey) {
                let val = row.original[extraColKey];
                if(Array.isArray(val)) val = val[0];
                // formatting for ER
                if(extraColKey === 'Avg ER' && typeof val === 'number') val = (val * 100).toFixed(2) + '%';
                extraVal = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${val || '-'}</td>`;
            }

            html += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeColor}">
                            ${row.classification}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emailHtml}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${linkHtml}</td>
                    ${extraVal}
                </tr>
            `;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }


    // ========================================
    // SEND ALL EMAILS LOGIC
    // ========================================

    async function sendAllEmails() {
        const btn = document.getElementById('send-all-btn');
        const pipeline = document.getElementById('pipeline-select').value;
        
        // Confirmation
        if(!confirm("Are you sure you want to send emails to all valid leads found?")) return;

        // Payload as requested: Only the pipeline
        const payload = {
            pipeline: pipeline
        };

        // UI: Fake Progress Display with "Nice Details"
        const modal = document.getElementById('sending-modal');
        const status = document.getElementById('sending-status');
        const title = document.getElementById('sending-title');
        const stepsDiv = document.getElementById('sending-steps');
        
        modal.classList.remove('hidden');
        title.textContent = "Initiating Email Sequence";
        status.textContent = "Preparing connection...";
        stepsDiv.classList.remove('hidden');
        
        // Disable main button
        btn.disabled = true;

        // Start fake visual progress
        setTimeout(() => {
            document.getElementById('step-1').classList.remove('hidden');
            status.textContent = "Packaging lead data...";
        }, 800);

        setTimeout(() => {
            document.getElementById('step-2').classList.remove('hidden');
            status.textContent = "Handshaking with mail server...";
        }, 2000);

        setTimeout(() => {
            document.getElementById('step-3').classList.remove('hidden');
            status.textContent = "Awaiting confirmation from webhook...";
        }, 3500);

        try {
            // Real Call
            const response = await fetch(EMAIL_SEND_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            // We wait for the response before showing success
            if (response.ok) {
                // Success UI
                title.textContent = "Sequence Started! üöÄ";
                title.classList.add('text-green-600');
                status.textContent = "The backend has accepted the request.";
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    showToast("Emails are being sent in the background!", "success");
                    btn.innerHTML = `<i class="fas fa-check mr-2"></i> Sent`;
                }, 2000);
            } else {
                throw new Error("Server responded with error");
            }
            
        } catch (e) {
            title.textContent = "Error";
            title.classList.add('text-red-600');
            status.textContent = "Failed to trigger email sequence.";
            console.error(e);
            setTimeout(() => {
                modal.classList.add('hidden');
                showToast("Failed to trigger emails", "error");
                btn.disabled = false;
            }, 2000);
        }
    }


    // ========================================
    // UTILS
    // ========================================
    function clearForm() {
        document.getElementById('campaign-json').value = '';
        validateJSON();
    }

    function startNewCampaign() {
        document.getElementById('results-section').classList.add('hidden');
        document.getElementById('status-section').classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      const icon = type === 'success' ? '<i class="fas fa-check-circle mr-2"></i>' : 
                   type === 'error' ? '<i class="fas fa-exclamation-circle mr-2"></i>' : '';

      const toast = document.createElement('div');
      toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center mb-2`;
      toast.innerHTML = `${icon}${message}`;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Init
    window.onload = function() {
        loadSampleJSON(); // Load initial sample
    };

  </script>
</body>
</html>
