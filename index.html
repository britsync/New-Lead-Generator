<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .pulse-ring { animation: pulse-ring 2s infinite; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .toast { position: fixed; top: 20px; right: 20px; z-index: 9999; animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">

<script>
const N8N_WEBHOOK_URL = 'https://primary-production-3af69.up.railway.app/webhook-test/NewLeadGen';
const CONFIG = { webhookUrl: N8N_WEBHOOK_URL };

let currentCampaignId = null;
let campaignStartTime = null;
let isDemoMode = false;
let isRunning = false;

function showToast(message, type = 'info', duration = 5000) {
    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

function validateJSON(str) {
    try { JSON.parse(str); return true; } catch { return false; }
}

function updateJSONValidation() {
    const json = document.getElementById('campaignJson').value.trim();
    const errorElement = document.getElementById('jsonError');
    const runBtn = document.getElementById('runCampaignBtn');
    if (json === '') { errorElement.classList.add('hidden'); runBtn.disabled = true; return; }
    if (validateJSON(json)) { errorElement.classList.add('hidden'); runBtn.disabled = false; }
    else { errorElement.textContent = 'Invalid JSON'; errorElement.classList.remove('hidden'); runBtn.disabled = true; }
}

function updateStatusUI(status, progress = 0, step = '') {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentStep = document.getElementById('currentStep');

    if (status === 'pending') statusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500';
    else if (status === 'running') statusIndicator.className = 'w-4 h-4 rounded-full bg-blue-500 pulse-ring';
    else if (status === 'completed') statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500';
    else if (status === 'error') statusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';

    statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    progressBar.style.width = progress + '%';
    progressText.textContent = progress + '%';
    currentStep.textContent = step || 'Processing...';
}

function startElapsedTimeCounter() {
    campaignStartTime = Date.now();
    const counter = setInterval(() => {
        if (isRunning) {
            const elapsed = Math.floor((Date.now() - campaignStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('elapsedTime').textContent = `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
        } else { clearInterval(counter); }
    }, 1000);
}

function extractResponseData(rawData) {
    console.log('ðŸ” RAW RESPONSE:', JSON.stringify(rawData, null, 2));

    // Direct format with leads
    if (rawData && rawData.leads && Array.isArray(rawData.leads)) {
        console.log('âœ… Direct leads array found:', rawData.leads.length, 'leads');
        return rawData;
    }

    // Handle [0].output[0].content[0].text.leads structure
    if (Array.isArray(rawData) && rawData.length > 0) {
        console.log('ðŸ“¦ Array detected, length:', rawData.length);
        const item = rawData[0];

        if (item.output && Array.isArray(item.output) && item.output.length > 0) {
            console.log('ðŸ“¦ Output array found');
            const output = item.output[0];

            if (output.content && Array.isArray(output.content) && output.content.length > 0) {
                console.log('ðŸ“¦ Content array found');
                const content = output.content[0];

                if (content.text) {
                    console.log('âœ… Text object found:', content.text);
                    if (content.text.leads) {
                        console.log('âœ… LEADS EXTRACTED:', content.text.leads.length, 'leads');
                        return content.text;
                    }
                    return content.text;
                }
            }
        }

        // Try direct item
        if (item.leads) {
            console.log('âœ… Leads in first item');
            return item;
        }
    }

    console.log('âš ï¸ No extraction pattern matched, returning as-is');
    return rawData;
}

function processLeadsData(data) {
    console.log('ðŸ“Š PROCESSING DATA:', data);

    const extractedData = extractResponseData(data);
    console.log('ðŸ“Š EXTRACTED DATA:', extractedData);

    if (extractedData && extractedData.leads && Array.isArray(extractedData.leads)) {
        const leads = extractedData.leads;
        console.log('ðŸ“Š Total leads:', leads.length);

        const hotLeads = leads.filter(l => {
            const classification = (l.classification || '').toLowerCase();
            console.log(`Lead ${l.lead_number}: ${l.business_name} - ${classification}`);
            return classification === 'hot';
        });

        const coldLeads = leads.filter(l => {
            const classification = (l.classification || '').toLowerCase();
            return classification === 'cold';
        });

        console.log(`âœ… HOT: ${hotLeads.length}, COLD: ${coldLeads.length}`);

        return {
            campaignId: extractedData.campaignId || 'campaign-' + Date.now(),
            hot_leads: {
                count: hotLeads.length,
                leads: hotLeads,
                word_report_url: extractedData.word_report_url || null,
                pdf_report_url: extractedData.pdf_report_url || null
            },
            other_leads: {
                count: coldLeads.length,
                leads: coldLeads
            }
        };
    }

    console.log('âŒ NO LEADS FOUND IN DATA');
    return { campaignId: 'unknown', hot_leads: { count: 0, leads: [] }, other_leads: { count: 0, leads: [] } };
}

async function triggerCampaign(campaignJson, pipeline) {
    if (!CONFIG.webhookUrl || CONFIG.webhookUrl === 'YOUR_N8N_WEBHOOK_URL_HERE') {
        showToast('âŒ Webhook URL not configured', 'error', 8000);
        return null;
    }

    console.log('ðŸ“¤ SENDING TO:', CONFIG.webhookUrl);

    try {
        const response = await fetch(CONFIG.webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({
                campaign_json: JSON.parse(campaignJson),
                pipeline: pipeline,
                timestamp: new Date().toISOString()
            })
        });

        console.log('ðŸ“Š Response status:', response.status);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const text = await response.text();
        console.log('ðŸ“„ RAW TEXT:', text);

        if (!text || text.trim() === '') throw new Error('Empty response');

        const rawData = JSON.parse(text);
        console.log('ðŸ“¦ PARSED DATA:', rawData);

        const processedData = processLeadsData(rawData);
        console.log('âœ… FINAL PROCESSED:', processedData);

        return processedData;

    } catch (error) {
        console.error('âŒ ERROR:', error);
        showToast(`âŒ Error: ${error.message}`, 'error', 8000);
        return null;
    }
}

function displayResults(data) {
    console.log('ðŸŽ¨ DISPLAYING RESULTS:', data);
    document.getElementById('resultsSection').classList.remove('hidden');

    const hotLeads = data.hot_leads || { count: 0, leads: [] };
    const otherLeads = data.other_leads || { count: 0, leads: [] };
    const totalLeads = (hotLeads.count || 0) + (otherLeads.count || 0);

    console.log('ðŸŽ¨ Hot:', hotLeads.count, 'Other:', otherLeads.count);

    document.getElementById('hotLeadsCount').textContent = hotLeads.count || 0;
    document.getElementById('otherLeadsCount').textContent = otherLeads.count || 0;
    document.getElementById('totalLeads').textContent = totalLeads;

    const conversionRate = totalLeads > 0 ? Math.round((hotLeads.count / totalLeads) * 100) : 0;
    document.getElementById('conversionPotential').textContent = conversionRate + '%';

    // Display hot leads details
    if (hotLeads.leads && hotLeads.leads.length > 0) {
        console.log('ðŸŽ¨ Displaying', hotLeads.leads.length, 'hot lead cards');
        const hotLeadsList = document.getElementById('hotLeadsList');
        hotLeadsList.innerHTML = '';

        hotLeads.leads.forEach((lead, index) => {
            console.log(`ðŸŽ¨ Creating card for: ${lead.business_name}`);
            const leadCard = document.createElement('div');
            leadCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-green-400 dark:border-green-600 shadow-sm';
            leadCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-lg text-gray-900 dark:text-white">${lead.business_name}</h4>
                    <span class="bg-green-500 text-white text-xs px-2 py-1 rounded">#${lead.lead_number}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 dark:text-gray-300">
                    <div>
                        <span class="font-semibold">ðŸ‘¥ Employees:</span> ${(lead.lead_data?.employees || 0).toLocaleString()}
                    </div>
                    <div>
                        <span class="font-semibold">ðŸ’° Revenue:</span> $${(lead.lead_data?.revenue || 0).toLocaleString()}
                    </div>
                    <div class="col-span-2">
                        <span class="font-semibold">ðŸ“± Followers:</span> ${(lead.lead_data?.social_media_followers || 0).toLocaleString()}
                    </div>
                </div>
            `;
            hotLeadsList.appendChild(leadCard);
        });
        document.getElementById('hotLeadsListSection').classList.remove('hidden');
    } else {
        console.log('âš ï¸ No hot leads to display');
        document.getElementById('hotLeadsListSection').classList.add('hidden');
    }

    if (campaignStartTime) {
        const duration = Math.floor((Date.now() - campaignStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        document.getElementById('campaignDuration').textContent = `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
    }
}

function resetDashboard() {
    document.getElementById('campaignJson').value = JSON.stringify({
        "campaign_name": "Tech Startups NYC",
        "target": { "industry": "Technology", "location": "New York, NY", "company_size": "1-50" },
        "scraping_sources": ["linkedin", "company_website"],
        "enrichment": { "enabled": true, "ai_scoring": true },
        "output_preferences": { "hot_lead_threshold": 8, "report_format": ["word", "pdf"], "email_language": "english" }
    }, null, 2);

    document.getElementById('statusSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('hotLeadsListSection').classList.add('hidden');
    document.getElementById('runCampaignBtn').disabled = false;
    currentCampaignId = null;
    isRunning = false;
    updateJSONValidation();
}

async function runDemoMode() {
    currentCampaignId = 'demo-' + Math.random().toString(36).substr(2, 9);
    document.getElementById('campaignId').textContent = currentCampaignId;

    const statuses = [
        { status: 'running', progress: 25, step: 'Scraping LinkedIn...' },
        { status: 'running', progress: 60, step: 'AI analysis...' },
        { status: 'completed', progress: 100, step: 'Complete!' }
    ];

    for (const s of statuses) {
        await new Promise(r => setTimeout(() => { updateStatusUI(s.status, s.progress, s.step); r(); }, 1000));
    }

    const mockResponse = {
        leads: [
            { lead_number: 1, business_name: "Global Enterprises", classification: "Hot", lead_data: { employees: 1200, revenue: 20000000, social_media_followers: 75000 }},
            { lead_number: 2, business_name: "Bright Future Ltd.", classification: "Cold", lead_data: { employees: 40, revenue: 800000, social_media_followers: 1500 }},
            { lead_number: 3, business_name: "Innovative Solutions", classification: "Hot", lead_data: { employees: 800, revenue: 30000000, social_media_followers: 95000 }},
        ]
    };

    displayResults(processLeadsData(mockResponse));
    showToast('âœ… Demo complete!', 'success');
    isRunning = false;
}

document.addEventListener('DOMContentLoaded', () => {
    resetDashboard();

    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', darkModeToggle.checked);
    });
    if (localStorage.getItem('darkMode') === 'true') {
        darkModeToggle.checked = true;
        document.documentElement.classList.add('dark');
    }

    const demoModeToggle = document.getElementById('demoModeToggle');
    demoModeToggle.addEventListener('change', () => {
        isDemoMode = demoModeToggle.checked;
        if (isDemoMode) showToast('ðŸŽ® Demo mode', 'info');
    });

    document.getElementById('campaignJson').addEventListener('input', updateJSONValidation);

    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-400'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-400'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.json')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('campaignJson').value = event.target.result;
                updateJSONValidation();
                showToast('ðŸ“„ Loaded', 'success');
            };
            reader.readAsText(file);
        }
    });
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('campaignJson').value = event.target.result;
                updateJSONValidation();
                showToast('ðŸ“„ Loaded', 'success');
            };
            reader.readAsText(file);
        }
    });

    document.getElementById('runCampaignBtn').addEventListener('click', async () => {
        const campaignJson = document.getElementById('campaignJson').value;
        const pipeline = document.getElementById('pipelineSelect').value;

        if (!validateJSON(campaignJson)) { showToast('âŒ Invalid JSON', 'error'); return; }

        document.getElementById('statusSection').classList.remove('hidden');
        updateStatusUI('pending', 0, 'Starting...');
        isRunning = true;
        startElapsedTimeCounter();
        document.getElementById('runCampaignBtn').disabled = true;

        if (isDemoMode) {
            await runDemoMode();
            document.getElementById('runCampaignBtn').disabled = false;
        } else {
            updateStatusUI('running', 10, 'Sending...');
            const response = await triggerCampaign(campaignJson, pipeline);

            if (response) {
                currentCampaignId = response.campaignId || 'unknown';
                document.getElementById('campaignId').textContent = currentCampaignId;
                updateStatusUI('completed', 100, 'Done!');
                displayResults(response);
                showToast('âœ… Complete!', 'success');
            } else {
                updateStatusUI('error', 0, 'Failed');
            }

            isRunning = false;
            document.getElementById('runCampaignBtn').disabled = false;
        }
    });

    document.getElementById('stopCampaignBtn').addEventListener('click', () => {
        isRunning = false;
        showToast('â¹ï¸ Stopped', 'warning');
        document.getElementById('runCampaignBtn').disabled = false;
    });

    document.getElementById('newCampaignBtn').addEventListener('click', () => {
        resetDashboard();
        window.scrollTo(0, 0);
    });
});
</script>

<div class="min-h-screen">
    <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Lead Generation Dashboard</h1>
                    <p class="text-gray-600 dark:text-gray-300 italic mt-1">Upload campaign JSON and trigger n8n workflow</p>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-3">Dark</span>
                        <input type="checkbox" id="darkModeToggle" class="w-5 h-5 rounded">
                    </label>
                    <label class="flex items-center cursor-pointer bg-blue-50 dark:bg-blue-900 px-3 py-2 rounded">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Demo</span>
                        <input type="checkbox" id="demoModeToggle" class="w-5 h-5 rounded">
                    </label>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Campaign Configuration</h2>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Upload JSON</label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400" id="dropZone">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Drag & drop or <span class="text-blue-600 font-medium">click</span></p>
                    <input type="file" id="fileInput" accept=".json" class="hidden">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Campaign JSON</label>
                <textarea id="campaignJson" class="w-full h-64 p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg font-mono text-sm"></textarea>
                <p class="text-xs text-red-600 dark:text-red-400 mt-2 hidden" id="jsonError"></p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pipeline</label>
                <select id="pipelineSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
                    <option value="linkedin">LinkedIn/Web</option>
                    <option value="google_maps">Google Maps</option>
                    <option value="social_media">Social Media</option>
                </select>
            </div>

            <button id="runCampaignBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg disabled:opacity-50">
                Run Campaign
            </button>
        </section>

        <section id="statusSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 hidden slide-in">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Status</h2>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Campaign ID</p>
                    <p class="text-lg font-mono font-bold text-gray-900 dark:text-white" id="campaignId">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Time</p>
                    <p class="text-lg font-bold text-gray-900 dark:text-white" id="elapsedTime">0s</p>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-4 h-4 rounded-full" id="statusIndicator"></div>
                    <span class="font-semibold text-gray-900 dark:text-white" id="statusText">Pending</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="currentStep">...</p>

                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                    <div id="progressBar" class="bg-blue-600 h-3 w-0 transition-all duration-500"></div>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2" id="progressText">0%</p>
            </div>

            <button id="stopCampaignBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Stop</button>
        </section>

        <section id="resultsSection" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">ðŸ”¥ Hot Leads</h2>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Total</p>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400" id="hotLeadsCount">0</p>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Rate</p>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="conversionPotential">0%</p>
                    </div>
                </div>

                <div id="hotLeadsListSection" class="mb-6 hidden">
                    <h3 class="font-bold text-gray-900 dark:text-white mb-3">Lead Details:</h3>
                    <div id="hotLeadsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 slide-in">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">ðŸ“§ Other Leads</h2>
                <p class="text-3xl font-bold text-gray-900 dark:text-white" id="otherLeadsCount">0</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Summary</h2>
                <div class="grid grid-cols-3 gap-4">
                    <div><p class="text-sm text-gray-600 dark:text-gray-400">Total</p><p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalLeads">0</p></div>
                    <div><p class="text-sm text-gray-600 dark:text-gray-400">Hot</p><p class="text-2xl font-bold text-green-600" id="hotLeadsCount2">-</p></div>
                    <div><p class="text-sm text-gray-600 dark:text-gray-400">Duration</p><p class="text-2xl font-bold text-gray-900 dark:text-white" id="campaignDuration">0s</p></div>
                </div>
                <button id="newCampaignBtn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">New Campaign</button>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 text-center py-6 mt-12">
        <p class="text-sm">Â© 2025 Lead Generation Dashboard</p>
    </footer>
</div>

</body>
</html>
